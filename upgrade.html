<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#3b82f6">
    <link rel="manifest" href='data:application/json,{
        "id": "/index.html",
        "name": "Succes Class",
        "short_name": "Succes",
        "start_url": "./",
        "display": "standalone",
        "orientation": "portrait",
        "background_color": "#ffffff",
        "theme_color": "#3b82f6",
        "icons": [
            { "src": "pwa_icon.png", "sizes": "512x512", "type": "image/png", "purpose": "any maskable" }
        ],
        "description": "Real-time AI Translation and Hybrid Learning Platform"
    }'>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Succes Class">
    <link rel="apple-touch-icon" href="pwa_icon.png">
    <title>Succes Class</title>

    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Fonts: Inter (Premium, clean sans-serif) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9', // Sky Blue
                            600: '#0284c7',
                            900: '#0c4a6e',
                        },
                        accent: {
                            500: '#8b5cf6', // Violet
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Premium Base Styles --- */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-blur: blur(12px);
            --shadow-soft: 0 10px 40px -10px rgba(0, 0, 0, 0.08);
            --shadow-hard: 0 20px 40px -10px rgba(0, 0, 0, 0.12);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f3f4f6 0%, #e0f2fe 100%);
            height: 100vh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            color: #1f2937;
        }

        /* Input Reset & Styling */
        .input-glass {
            background: rgba(255, 255, 255, 0.6);
            -webkit-backdrop-filter: blur(8px);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .input-glass:focus {
            background: #ffffff;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.15), inset 0 2px 4px rgba(0, 0, 0, 0.01);
            outline: none;
        }

        /* Buttons */
        .btn-modern {
            transition: transform 0.1s ease, box-shadow 0.2s ease, background 0.2s ease;
        }

        .btn-modern:active {
            transform: scale(0.97);
        }

        /* Scrollbar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .animate-pulse-red {
            animation: pulse-red 2s infinite;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        /* Utilities */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-soft);
        }

        .message-bubble {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: transform 0.2s;
            transform-origin: bottom left;
        }

        .mic-active-ring {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* Animations */
        .view-transition {
            transition: opacity 0.4s ease, transform 0.4s ease;
        }

        .view-hidden {
            opacity: 0;
            pointer-events: none;
            position: absolute;
            inset: 0;
            transform: scale(0.98);
            z-index: -1;
        }

        .view-active {
            opacity: 1;
            pointer-events: auto;
            position: relative;
            transform: scale(1);
            z-index: 10;
        }
    </style>
</head>

<body class="antialiased text-gray-800">

    <!-- Toast Container -->
    <div id="toast-container"
        class="fixed top-4 left-0 right-0 z-50 pointer-events-none flex flex-col items-center gap-2 p-4"></div>

    <!-- MAIN APP CONTAINER -->
    <main id="app"
        class="relative w-full h-full lg:max-w-5xl mx-auto bg-white/50 shadow-2xl overflow-hidden lg:rounded-2xl lg:my-8 lg:h-[calc(100vh-4rem)] lg:border lg:border-white/50 backdrop-blur-3xl">

        <!-- ================= VIEW: LOGIN ================= -->
        <section id="view-login"
            class="view-active w-full h-full flex flex-col p-8 transition-all duration-500 overflow-y-auto">
            <div class="w-full max-w-md mx-auto flex flex-col h-full">
                <!-- Header/Logo -->
                <div class="flex-1 flex flex-col items-center justify-center space-y-6 animate-slide-up">
                    <div class="relative w-28 h-28">
                        <div class="relative w-full h-full flex items-center justify-center">
                            <div
                                class="w-24 h-24 rounded-3xl bg-white/80 border border-white/80 shadow-xl shadow-blue-500/10 flex items-center justify-center">
                                <img src="pwa_icon.png" alt="Succes Class" class="w-20 h-20 rounded-2xl object-contain">
                            </div>
                            <div
                                class="absolute -right-2 -top-2 bg-emerald-50 text-emerald-600 text-[10px] font-bold px-1.5 py-0.5 rounded-md border border-emerald-100">
                                verified</div>
                        </div>
                    </div>
                </div>



                <!-- Login Form (Student) -->
                <div id="form-student" class="w-full space-y-5 mb-4 animate-slide-up" style="animation-delay: 0.1s;">
                    <div class="group">
                        <label class="block text-sm font-semibold text-gray-500 mb-1.5 ml-1">Conversation Code</label>
                        <div class="relative flex gap-2">
                            <input id="login-code" type="text" placeholder="Enter conversation code"
                                class="input-glass flex-1 px-4 py-3.5 rounded-lg text-base font-medium text-gray-800 placeholder-gray-400 bg-gray-50/50 border-gray-200 focus:bg-white transition-all">
                            <div
                                class="w-12 flex items-center justify-center bg-gray-100 rounded-lg text-gray-500 text-2xl">
                                <i class="fa-solid fa-qrcode"></i>
                            </div>
                        </div>
                    </div>

                    <div class="group">
                        <label class="block text-sm font-semibold text-gray-500 mb-1.5 ml-1">Username</label>
                        <input id="login-name" type="text" placeholder="Enter Username"
                            class="input-glass w-full px-4 py-3.5 rounded-lg text-base font-medium text-gray-800 placeholder-gray-400 bg-gray-50/50 border-gray-200 focus:bg-white">
                    </div>

                    <div class="group">
                        <label class="block text-sm font-semibold text-gray-500 mb-1.5 ml-1">Receiving Language</label>
                        <div class="relative">
                            <select id="login-lang" title="Select your receiving language"
                                class="input-glass w-full px-4 py-3.5 rounded-lg text-base font-medium text-gray-800 appearance-none bg-gray-50/50 border-gray-200 focus:bg-white pr-10 truncate">
                                <!-- Populated dynamically -->
                            </select>
                            <i
                                class="fa-solid fa-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                    </div>



                    <button onclick="App.handleLogin()"
                        class="btn-modern w-full bg-[#0ea5e9] hover:bg-[#0284c7] text-white font-semibold py-3.5 rounded-lg shadow-lg shadow-blue-500/20 flex items-center justify-center gap-2 mt-4 text-lg">
                        <span>Join Conversation</span>
                    </button>
                </div>

                <!-- Teacher Login Form (Hidden by default) -->
                <div id="form-teacher" class="hidden w-full space-y-5 mb-4 animate-slide-up">
                    <div class="group">
                        <label class="block text-sm font-semibold text-gray-500 mb-1.5 ml-1"
                            for="teacher-email">Email</label>
                        <input id="teacher-email" type="email" value="teacher@adahconnect.com" placeholder="Email"
                            title="Teacher Email"
                            class="input-glass w-full px-4 py-3.5 rounded-lg text-base font-medium text-gray-800 placeholder-gray-400 bg-gray-50/50 border-gray-200 focus:bg-white">
                    </div>
                    <div class="group">
                        <label class="block text-sm font-semibold text-gray-500 mb-1.5 ml-1"
                            for="teacher-pw">Password</label>
                        <input id="teacher-pw" type="password" value="teacher456321" placeholder="Password"
                            title="Teacher Password"
                            class="input-glass w-full px-4 py-3.5 rounded-lg text-base font-medium text-gray-800 placeholder-gray-400 bg-gray-50/50 border-gray-200 focus:bg-white">
                    </div>
                    <div class="group">
                        <label class="block text-sm font-semibold text-gray-500 mb-1.5 ml-1">Language</label>
                        <div class="relative">
                            <select id="teacher-lang" title="Select your instruction language"
                                class="input-glass w-full px-4 py-3.5 rounded-lg text-base font-medium text-gray-800 appearance-none bg-gray-50/50 border-gray-200 focus:bg-white pr-10 truncate">
                                <!-- Populated dynamically -->
                            </select>
                            <i
                                class="fa-solid fa-caret-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                    </div>

                    <button onclick="App.handleTeacherLogin()"
                        class="btn-modern w-full bg-[#22c55e] hover:bg-[#16a34a] text-white font-semibold py-3.5 rounded-lg shadow-lg shadow-green-500/20 flex items-center justify-center gap-2 mt-4 text-lg">
                        <span>Login & Start</span>
                    </button>
                    <button onclick="App.toggleTeacherMode(false)"
                        class="w-full py-2 text-sm font-semibold text-gray-400 hover:text-gray-600">
                        Cancel
                    </button>
                </div>


                <!-- Footer / Toggle -->
                <div id="login-footer" class="text-center animate-slide-up mt-auto pt-4 space-y-3"
                    style="animation-delay: 0.2s;">
                    <button onclick="App.toggleTeacherMode(true)"
                        class="w-full py-3.5 rounded-lg font-semibold text-white bg-[#22c55e] hover:bg-[#16a34a] shadow-lg shadow-green-500/20 transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-graduation-cap"></i>
                        <span>Teacher Access</span>
                    </button>
                    <button onclick="App.toggleModal('permissions')"
                        class="w-full py-3 rounded-lg font-bold text-gray-500 bg-gray-50 hover:bg-gray-100 transition-all flex items-center justify-center gap-2 text-xs uppercase tracking-widest border border-gray-100">
                        <i class="fa-solid fa-shield-halved"></i>
                        <span>Check Permissions</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- ================= VIEW: TEACHER LOBBY (QR) ================= -->
        <section id="view-lobby" class="view-hidden w-full h-full flex flex-col bg-white text-center p-8">
            <div class="flex-1 flex flex-col items-center justify-center space-y-8 animate-slide-up">
                <h2 class="text-2xl font-bold text-gray-900">Classroom Ready</h2>

                <div class="bg-white p-6 rounded-3xl shadow-xl border border-gray-100 relative">
                    <div class="absolute inset-0 bg-blue-500/5 rounded-3xl blur-xl -z-10"></div>
                    <!-- QR Placeholder -->
                    <div
                        class="w-48 h-48 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600 text-6xl shadow-inner mb-4 border border-blue-100">
                        <i class="fa-solid fa-qrcode"></i>
                    </div>
                    <div class="space-y-1">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Room Code</p>
                        <p id="lobby-code" class="text-4xl font-mono font-black text-blue-600 tracking-widest">----</p>
                    </div>
                </div>

                <p class="text-gray-500 max-w-xs mx-auto text-sm">Share this code with students to let them join the
                    conversation.</p>
            </div>

            <div class="flex flex-col gap-3 w-full">
                <button onclick="App.startSession()"
                    class="btn-modern w-full bg-[#22c55e] hover:bg-[#16a34a] text-white font-bold py-4 rounded-xl shadow-lg shadow-green-500/20 flex items-center justify-center gap-3 animate-slide-up">
                    <span>Start Session</span>
                    <i class="fa-solid fa-play"></i>
                </button>
                <button onclick="App.shareRoom()"
                    class="btn-modern w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-500/10 flex items-center justify-center gap-3 animate-slide-up"
                    style="animation-delay: 0.1s;">
                    <span>Share Room Link</span>
                    <i class="fa-solid fa-share-nodes"></i>
                </button>
            </div>
        </section>

        <!-- ================= VIEW: STUDENT ================= -->
        <section id="view-student" class="view-hidden w-full h-full flex flex-col bg-white">
            <!-- Navbar -->
            <header
                class="h-16 px-4 md:px-6 flex items-center justify-between bg-white/80 backdrop-blur-md sticky top-0 z-30 border-b border-gray-100 overflow-hidden">
                <div class="flex items-center gap-3 min-w-0">
                    <button onclick="App.logout()" title="Logout"
                        class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-500 hover:text-gray-900 transition-colors">
                        <i class="fa-solid fa-arrow-left text-sm"></i>
                    </button>
                    <div>
                        <h2 id="student-name-display"
                            class="font-bold text-gray-900 leading-tight text-sm truncate max-w-[150px]">Student
                        </h2>
                        <div class="flex items-center gap-1">
                            <span class="text-[9px] text-gray-400 font-bold uppercase tracking-tight">Receiving:</span>
                            <span id="student-lang-badge"
                                class="text-[10px] font-black uppercase text-blue-600">EN</span>
                        </div>
                    </div>
                </div>
                <!-- Status & Audio Toggle -->
                <div class="flex items-center gap-4">
                    <button onclick="App.toggleModal('history')" title="View History"
                        class="text-gray-400 hover:text-blue-500 transition-colors">
                        <i class="fa-solid fa-clock-rotate-left"></i>
                    </button>
                    <button id="tts-btn" onclick="App.toggleTTS()" title="Toggle Voice Output"
                        class="text-gray-400 hover:text-blue-500 transition-colors">
                        <i id="tts-icon" class="fa-solid fa-volume-xmark"></i>
                    </button>
                    <span class="relative flex h-3 w-3">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                    </span>
                </div>
            </header>

            <!-- Chat Stream -->
            <div id="student-stream"
                class="flex-1 overflow-y-auto p-6 space-y-6 pb-32 bg-gray-50/50 custom-scrollbar scroll-smooth">
                <!-- Welcome Message -->
                <div class="text-center py-10 opacity-60">
                    <div
                        class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400 text-xl">
                        <i class="fa-solid fa-ear-listen"></i>
                    </div>
                    <p class="text-sm font-medium text-gray-500">Connected to <span
                            class="font-mono text-gray-700 font-bold" id="student-room-code">...</span></p>
                    <p class="text-xs text-gray-400 mt-1">Listening for speech...</p>
                </div>
            </div>

            <!-- Mobile Bottom Navbar -->
            <nav
                class="md:hidden sticky bottom-0 left-0 right-0 bg-white/80 backdrop-blur-xl border-t border-gray-100 px-6 py-3 z-30 flex items-center justify-between shadow-[0_-4px_20px_rgba(0,0,0,0,03)]">
                <button onclick="App.scrollToBottom()"
                    class="flex flex-col items-center gap-1 text-blue-600 transition-all active:scale-90">
                    <div class="w-10 h-10 rounded-2xl bg-blue-50 flex items-center justify-center">
                        <i class="fa-solid fa-house-chimney text-lg"></i>
                    </div>
                    <span class="text-[10px] font-bold uppercase tracking-tighter">Home</span>
                </button>

                <button onclick="App.toggleModal('question')"
                    class="flex flex-col items-center gap-1 text-gray-400 hover:text-blue-500 transition-all active:scale-95">
                    <div class="w-10 h-10 rounded-2xl bg-gray-50 flex items-center justify-center">
                        <i class="fa-solid fa-hand text-lg"></i>
                    </div>
                    <span class="text-[10px] font-bold uppercase tracking-tighter">Ask</span>
                </button>

                <!-- Center FAB for important action? Or just keep it even. Let's do even for now. -->

                <button onclick="App.toggleModal('history')"
                    class="flex flex-col items-center gap-1 text-gray-400 hover:text-blue-500 transition-all active:scale-95">
                    <div class="w-10 h-10 rounded-2xl bg-gray-50 flex items-center justify-center">
                        <i class="fa-solid fa-clock-rotate-left text-lg"></i>
                    </div>
                    <span class="text-[10px] font-bold uppercase tracking-tighter">History</span>
                </button>

                <button onclick="App.toggleModal('permissions')"
                    class="flex flex-col items-center gap-1 text-gray-400 hover:text-blue-500 transition-all active:scale-95">
                    <div class="w-10 h-10 rounded-2xl bg-gray-50 flex items-center justify-center">
                        <i class="fa-solid fa-shield-halved text-lg"></i>
                    </div>
                    <span class="text-[10px] font-bold uppercase tracking-tighter">Status</span>
                </button>
            </nav>

            <!-- Reactions (Floating above Navbar) -->
            <div class="md:hidden absolute bottom-24 right-6 flex flex-col gap-3 z-20">
                <button onclick="App.sendReaction('üëç')"
                    class="btn-modern w-12 h-12 rounded-full bg-white/90 backdrop-blur-md border border-white shadow-xl text-xl flex items-center justify-center hover:bg-gray-50 hover:scale-110 active:scale-90 transition-all">üëç</button>
                <button onclick="App.sendReaction('‚ù§Ô∏è')"
                    class="btn-modern w-12 h-12 rounded-full bg-white/90 backdrop-blur-md border border-white shadow-xl text-xl flex items-center justify-center hover:bg-gray-50 hover:scale-110 active:scale-90 transition-all">‚ù§Ô∏è</button>
            </div>

            <!-- Desktop Controls (Original logic preserved for larger screens) -->
            <div
                class="hidden md:block absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-white via-white to-transparent z-20">
                <div class="flex items-center justify-between gap-4">
                    <div class="flex gap-3">
                        <button onclick="App.sendReaction('üëç')"
                            class="btn-modern w-12 h-12 rounded-full bg-white border border-gray-200 shadow-sm text-xl flex items-center justify-center hover:bg-gray-50 hover:scale-110">üëç</button>
                        <button onclick="App.sendReaction('‚ù§Ô∏è')"
                            class="btn-modern w-12 h-12 rounded-full bg-white border border-gray-200 shadow-sm text-xl flex items-center justify-center hover:bg-gray-50 hover:scale-110">‚ù§Ô∏è</button>
                    </div>

                    <button onclick="App.toggleModal('question')"
                        class="btn-modern h-12 px-6 rounded-full bg-[#0ea5e9] hover:bg-[#0284c7] text-white font-semibold shadow-lg shadow-blue-500/20 flex items-center gap-2">
                        <i class="fa-solid fa-hand"></i>
                        <span>Raise Hand</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- ================= VIEW: TEACHER (DASHBOARD) ================= -->
        <section id="view-teacher" class="view-hidden w-full h-full flex flex-col bg-slate-50">
            <!-- Header -->
            <header
                class="h-16 px-4 md:px-6 bg-white border-b border-gray-200 flex justify-between items-center shadow-sm z-30 overflow-hidden">
                <div class="flex items-center gap-2 md:gap-3 min-w-0">
                    <button onclick="App.logout()" title="Logout"
                        class="text-gray-400 hover:text-red-500 transition-colors">
                        <i class="fa-solid fa-power-off"></i>
                    </button>
                    <div class="h-6 w-px bg-gray-200 mx-1"></div>
                    <div class="flex items-center gap-2">
                        <div>
                            <h1 class="font-bold text-gray-900 text-sm">Teacher</h1>
                            <div class="flex items-center gap-1.5 cursor-pointer hover:bg-gray-100 px-1.5 rounded transition-colors"
                                onclick="App.copyCode()">
                                <p class="text-xs text-gray-500 font-mono tracking-wider " id="teacher-code-display">
                                    CODE
                                </p>
                                <i class="fa-regular fa-copy text-[10px] text-gray-400"></i>
                            </div>
                        </div>
                        <button onclick="App.shareRoom()" title="Share Room"
                            class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 hover:text-blue-500 transition-colors">
                            <i class="fa-solid fa-share-nodes text-xs"></i>
                        </button>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex items-center gap-3">
                    <!-- Source Selector -->
                    <div class="relative group w-28 md:w-auto">
                        <select id="audio-source-select" onchange="App.handleAudioSourceChange(this.value)"
                            title="Select Audio Source"
                            class="appearance-none bg-gray-100 hover:bg-gray-200 text-gray-600 text-xs font-bold py-2 pl-3 pr-8 rounded-full border-none focus:ring-2 focus:ring-blue-500 cursor-pointer transition-colors">
                            <option value="mic">üé§ Mic</option>
                            <option value="system">üñ•Ô∏è System Audio</option>
                        </select>
                        <i
                            class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-gray-500 pointer-events-none"></i>
                    </div>

                    <button onclick="App.toggleModal('history')" title="View History"
                        class="text-gray-400 hover:text-blue-500 transition-colors">
                        <i class="fa-solid fa-clock-rotate-left"></i>
                    </button>
                    <button id="teacher-tts-btn" onclick="App.toggleTTS()" title="Toggle Voice Output"
                        class="text-gray-400 hover:text-blue-500 transition-colors">
                        <i id="teacher-tts-icon" class="fa-solid fa-volume-xmark"></i>
                    </button>
                    <!-- Mic Toggle -->
                    <button id="mic-btn" onclick="App.toggleMic()" title="Toggle Broadcast"
                        class="btn-modern relative w-10 h-10 flex-shrink-0 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center transition-all hover:bg-gray-200">
                        <i class="fa-solid fa-microphone-slash text-sm"></i>
                    </button>
                </div>
            </header>

            <main class="flex-1 p-4 grid grid-rows-2 gap-4 h-[calc(100%-4rem)]">
                <!-- Live Transcript Area -->
                <div
                    class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden relative group">
                    <div class="px-4 py-3 bg-gray-50/50 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-2">
                            <i class="fa-solid fa-wave-square text-blue-500"></i> Live Audio
                        </h3>
                        <div id="mic-status" class="flex gap-1">
                            <div class="w-1 h-3 bg-gray-300 rounded-full animate-pulse"></div>
                            <div class="w-1 h-3 bg-gray-300 rounded-full animate-pulse" style="animation-delay: 0.1s">
                            </div>
                            <div class="w-1 h-3 bg-gray-300 rounded-full animate-pulse" style="animation-delay: 0.2s">
                            </div>
                        </div>
                    </div>

                    <div id="teacher-transcript"
                        class="flex-1 p-5 overflow-y-auto text-xl font-medium text-gray-400 italic leading-relaxed custom-scrollbar relative">
                        Tap the microphone to start broadcasting...

                        <!-- Floating Magic Toggle -->
                        <button onclick="App.toggleMagicInput()"
                            class="absolute bottom-4 right-4 w-8 h-8 rounded-full bg-white shadow-md border border-gray-100 flex items-center justify-center text-purple-500 hover:bg-purple-50 transition-all z-10"
                            title="AI Lesson Generator">
                            <i class="fa-solid fa-wand-magic-sparkles text-xs"></i>
                        </button>
                    </div>

                    <!-- Collapsible AI Input -->
                    <div id="ai-input-container"
                        class="bg-purple-50 border-t border-purple-100 transition-all duration-300 overflow-hidden"
                        style="max-height: 0px;">
                        <div class="p-3 space-y-3">
                            <!-- Step 1: Topic Input -->
                            <div id="ai-step-1" class="relative transition-all duration-300">
                                <input id="magic-topic" type="text" placeholder="Enter topic to generate lesson..."
                                    class="w-full bg-white rounded-xl px-4 py-2.5 text-sm focus:ring-2 focus:ring-purple-500 outline-none border border-purple-100 transition-all pl-9"
                                    onkeydown="if(event.key === 'Enter') App.generateAIContent(this.value)">
                                <i
                                    class="fa-solid fa-wand-magic-sparkles absolute left-3 top-1/2 -translate-y-1/2 text-purple-400 text-xs"></i>
                                <button onclick="App.toggleMagicInput()" title="Close Magic Input"
                                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                    <i class="fa-solid fa-xmark text-xs"></i>
                                </button>
                                <!-- History Toggle -->
                                <button onclick="App.toggleHistoryView()"
                                    class="absolute right-10 top-1/2 -translate-y-1/2 text-gray-400 hover:text-purple-600"
                                    title="View History">
                                    <i class="fa-solid fa-clock-rotate-left text-xs"></i>
                                </button>

                                <!-- PRESETS -->
                                <div class="flex gap-2 mt-3 overflow-x-auto custom-scrollbar pb-1 px-1">
                                    <button onclick="App.generateAIContent('Construction Safety')"
                                        class="whitespace-nowrap px-3 py-1.5 bg-white border border-orange-100 text-orange-600 rounded-full text-[10px] font-bold shadow-sm hover:bg-orange-50 transition-colors flex items-center gap-1.5">
                                        <i class="fa-solid fa-helmet-safety"></i> Construction Safety
                                    </button>
                                    <button onclick="App.generateAIContent('Workplace Hazards')"
                                        class="whitespace-nowrap px-3 py-1.5 bg-white border border-red-100 text-red-600 rounded-full text-[10px] font-bold shadow-sm hover:bg-red-50 transition-colors flex items-center gap-1.5">
                                        <i class="fa-solid fa-triangle-exclamation"></i> Hazards
                                    </button>
                                    <button onclick="App.generateAIContent('First Aid Basics')"
                                        class="whitespace-nowrap px-3 py-1.5 bg-white border border-green-100 text-green-600 rounded-full text-[10px] font-bold shadow-sm hover:bg-green-50 transition-colors flex items-center gap-1.5">
                                        <i class="fa-solid fa-briefcase-medical"></i> First Aid
                                    </button>
                                </div>
                            </div>

                            <!-- History View -->
                            <div id="ai-history-view" class="hidden h-full flex flex-col animate-fade-in">
                                <div class="flex items-center justify-between mb-2 pb-2 border-b border-gray-100">
                                    <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider">Lesson History
                                    </h4>
                                    <button onclick="App.toggleHistoryView()"
                                        class="text-xs text-purple-600 hover:text-purple-800 font-bold">
                                        <i class="fa-solid fa-arrow-left"></i> Back
                                    </button>
                                </div>
                                <div id="history-list"
                                    class="flex-1 overflow-y-auto custom-scrollbar space-y-2 max-h-[150px]">
                                    <!-- History Items -->
                                    <div class="text-center py-4 text-xs text-gray-400 italic">No history yet</div>
                                </div>
                            </div>

                            <!-- Step 2: Review & Broadcast -->
                            <div id="ai-step-2" class="hidden flex flex-col h-full animate-fade-in relative">
                                <textarea id="magic-review"
                                    class="w-full flex-1 p-3 bg-gray-50 rounded-lg text-sm text-gray-700 resize-none border border-gray-200 focus:outline-none focus:border-purple-300 focus:bg-white transition-colors"
                                    placeholder="Review generated lesson..."></textarea>

                                <div class="flex items-center justify-end gap-2 mt-2">
                                    <button onclick="App.resetAIInput()"
                                        class="px-3 py-1.5 text-xs font-medium text-gray-500 hover:text-gray-700">
                                        Cancel
                                    </button>

                                    <!-- Start Button -->
                                    <button id="btn-start-broadcast" onclick="App.startBroadcastSequence()"
                                        class="px-4 py-1.5 bg-gradient-to-r from-purple-500 to-indigo-600 text-white text-xs font-bold rounded-full shadow-md hover:shadow-lg transition-all flex items-center gap-2">
                                        <i class="fa-solid fa-tower-broadcast"></i> Start Broadcast (2s Delay)
                                    </button>

                                    <!-- Stop Button (Hidden by default) -->
                                    <button id="btn-stop-broadcast" onclick="App.stopBroadcast()"
                                        class="hidden px-4 py-1.5 bg-red-500 text-white text-xs font-bold rounded-full shadow-md hover:bg-red-600 transition-all flex items-center gap-2 animate-pulse-red">
                                        <i class="fa-solid fa-stop"></i> STOP
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Local TTS Toggle -->
                        <div
                            class="mt-4 flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-100">
                            <div class="flex items-center gap-2">
                                <div
                                    class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600">
                                    <i class="fa-solid fa-server text-xs"></i>
                                </div>
                                <div class="text-xs">
                                    <div class="font-bold text-gray-700">Local Orbit Beta TTS</div>
                                    <div class="text-[10px] text-gray-400">Use Docker backend</div>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="toggle-local-tts" class="sr-only peer"
                                    onchange="App.toggleLocalTTS(this.checked)">
                                <div
                                    class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-yellow-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-yellow-500">
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Incoming Questions -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col overflow-hidden">
                    <div class="px-4 py-3 bg-gray-50/50 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">Student Questions</h3>
                        <span id="question-count"
                            class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded-full">0</span>
                    </div>
                    <div id="teacher-questions"
                        class="flex-1 p-4 overflow-y-auto space-y-3 bg-gray-50 custom-scrollbar">
                        <!-- Questions injected here -->
                        <div class="text-center py-8 opacity-40">
                            <i class="fa-regular fa-comments text-2xl mb-2 text-gray-400"></i>
                            <p class="text-xs text-gray-500">No questions yet</p>
                        </div>
                    </div>
                </div>
            </main>
        </section>

        <!-- ================= MODAL: QUESTION ================= -->
        <div id="modal-question" class="fixed inset-0 z-50 hidden">
            <!-- Backdrop -->
            <div class="absolute inset-0 bg-gray-900/40 backdrop-blur-sm transition-opacity opacity-0"
                id="modal-backdrop" onclick="App.toggleModal('question')"></div>

            <!-- Content -->
            <div class="absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:w-full md:max-w-sm md:-translate-x-1/2 md:-translate-y-1/2 transition-transform transform translate-y-full"
                id="modal-panel">
                <div class="bg-white rounded-t-2xl md:rounded-2xl shadow-2xl p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-1">Ask a Question</h3>
                    <p class="text-sm text-gray-500 mb-6">Your question will be translated for the teacher.</p>

                    <div class="relative mb-6">
                        <input id="q-input" type="text"
                            class="w-full border-2 border-gray-100 rounded-xl px-4 py-3 text-base outline-none focus:border-blue-500 transition-colors"
                            placeholder="Type your question..."
                            onkeydown="if(event.key === 'Enter') App.sendQuestion()">
                    </div>

                    <div class="flex gap-3">
                        <button onclick="App.toggleModal('question')"
                            class="flex-1 py-3 text-sm font-bold text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition-colors">Cancel</button>
                        <button onclick="App.sendQuestion()"
                            class="flex-1 py-3 text-sm font-bold text-white bg-blue-600 rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-500/20 transition-colors">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= MODAL: HISTORY ================= -->
        <div id="modal-history" class="fixed inset-0 z-50 hidden">
            <!-- Backdrop -->
            <div class="absolute inset-0 bg-gray-900/40 backdrop-blur-sm transition-opacity opacity-0"
                id="history-backdrop" onclick="App.toggleModal('history')"></div>

            <!-- Content -->
            <div class="absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:w-full md:max-w-lg md:-translate-x-1/2 md:-translate-y-1/2 transition-transform transform translate-y-full"
                id="history-panel">
                <div class="bg-white rounded-t-3xl md:rounded-3xl shadow-2xl flex flex-col h-[70vh]">
                    <div
                        class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 rounded-t-3xl border-t-4 border-blue-500">
                        <div>
                            <h3 class="text-xl font-black text-gray-900 leading-none">History</h3>
                            <p class="text-xs text-gray-500 mt-1 font-bold uppercase tracking-widest">Session Archive
                            </p>
                        </div>
                        <button onclick="App.toggleModal('history')" title="Close History"
                            class="w-10 h-10 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-500 hover:text-gray-900 shadow-sm transition-all active:scale-95">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>

                    <div id="history-content"
                        class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50/50 custom-scrollbar">
                        <!-- History items injected here -->
                        <div class="text-center py-20 opacity-30">
                            <i class="fa-solid fa-hourglass-start text-4xl mb-4"></i>
                            <p class="text-sm font-bold">No history available yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= MODAL: INSTALL APP ================= -->
        <div id="modal-install" class="fixed inset-0 z-50 hidden">
            <!-- Backdrop -->
            <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-md transition-opacity opacity-0"
                id="install-backdrop" onclick="App.toggleModal('install', false)"></div>

            <!-- Content -->
            <div class="absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:w-full md:max-w-sm md:-translate-x-1/2 md:-translate-y-1/2 transition-transform transform translate-y-full"
                id="install-panel">
                <div class="bg-white rounded-t-[2.5rem] md:rounded-[2.5rem] shadow-2xl p-8 text-center relative">
                    <!-- Close button -->
                    <button onclick="App.toggleModal('install', false)" title="Close"
                        class="absolute top-6 right-6 w-10 h-10 flex items-center justify-center text-gray-400 hover:text-gray-900 transition-colors">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>

                    <!-- App Icon -->
                    <div
                        class="w-24 h-24 bg-blue-600/10 rounded-3xl mx-auto mb-4 flex items-center justify-center text-white text-5xl shadow-xl shadow-blue-500/20">
                        <img src="pwa_icon.png" alt="Succes Class" class="w-20 h-20 rounded-2xl object-contain">
                    </div>

                    <h3 class="text-2xl font-black text-gray-900 mb-6">Succes</h3>

                    <p class="text-gray-500 text-sm leading-relaxed mb-6">
                        Scan the QR code to launch this page on your Android device, and then download and install the
                        APK.
                    </p>

                    <!-- QR Code -->
                    <div class="bg-white p-4 inline-block rounded-3xl border border-gray-100 shadow-sm mb-8">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://median.co/share/bnlnnpk%23apk"
                            alt="Download QR" class="w-[200px] h-[200px]">
                    </div>

                    <!-- Instructions / Buttons -->
                    <div class="space-y-3">
                        <a href="https://success.eburon.ai/app.apk" target="_blank" rel="noopener"
                            class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-2xl shadow-lg shadow-blue-500/20 transition-all flex items-center justify-center gap-3 active:scale-95">
                            <i class="fa-solid fa-download"></i>
                            <span>Download Android APK</span>
                        </a>
                    </div>

                    <p class="text-[11px] text-gray-400 mt-6 leading-relaxed">
                        After downloading open the APK and accept all prompts.
                    </p>
                </div>
            </div>
            <!-- ================= MODAL: PERMISSIONS ================= -->
            <div id="modal-permissions" class="fixed inset-0 z-50 hidden">
                <!-- Backdrop -->
                <div class="absolute inset-0 bg-gray-900/40 backdrop-blur-sm transition-opacity opacity-0"
                    id="permissions-backdrop" onclick="App.toggleModal('permissions')"></div>

                <!-- Content -->
                <div class="absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:w-full md:max-w-sm md:-translate-x-1/2 md:-translate-y-1/2 transition-transform transform translate-y-full"
                    id="permissions-panel">
                    <div class="bg-white rounded-t-[2rem] md:rounded-[2rem] shadow-2xl p-6">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-xl font-black text-gray-900 leading-none">Permissions</h3>
                                <p class="text-xs text-gray-500 mt-1 uppercase tracking-widest font-bold">System Status
                                </p>
                            </div>
                            <button onclick="App.toggleModal('permissions')"
                                class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-400 hover:text-gray-900 transition-colors">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>

                        <div class="space-y-3 mb-6">
                            <div
                                class="flex items-center justify-between p-4 bg-gray-50 rounded-2xl border border-gray-100">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-blue-500 shadow-sm">
                                        <i class="fa-solid fa-microphone"></i>
                                    </div>
                                    <div class="text-sm font-bold text-gray-700">Microphone</div>
                                </div>
                                <div id="perm-mic" class="text-[10px] font-black uppercase text-amber-500">required
                                </div>
                            </div>

                            <div
                                class="flex items-center justify-between p-4 bg-gray-50 rounded-2xl border border-gray-100">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-purple-500 shadow-sm">
                                        <i class="fa-solid fa-bell"></i>
                                    </div>
                                    <div class="text-sm font-bold text-gray-700">Notifications</div>
                                </div>
                                <div id="perm-notifications" class="text-[10px] font-black uppercase text-amber-500">
                                    required</div>
                            </div>

                            <div
                                class="flex items-center justify-between p-4 bg-gray-50 rounded-2xl border border-gray-100">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-orange-500 shadow-sm">
                                        <i class="fa-solid fa-battery-full"></i>
                                    </div>
                                    <div class="text-sm font-bold text-gray-700">Wake Lock</div>
                                </div>
                                <div id="perm-wakelock" class="text-[10px] font-black uppercase text-amber-500">required
                                </div>
                            </div>
                        </div>

                        <button onclick="App.requestPermissions()"
                            class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-2xl shadow-lg shadow-blue-500/20 transition-all flex items-center justify-center gap-3 active:scale-95">
                            <i class="fa-solid fa-shield-check"></i>
                            <span>Enable All Access</span>
                        </button>

                        <p class="text-[10px] text-gray-400 mt-4 text-center leading-relaxed px-4">Permissions are
                            verified on device and stored locally for your security.</p>
                    </div>
                </div>
            </div>

            <!-- ================= MODAL: SCREEN SHARE CONFIRMATION ================= -->
            <div id="modal-screenshare" class="fixed inset-0 z-50 hidden">
                <!-- Backdrop -->
                <div class="absolute inset-0 bg-gray-900/40 backdrop-blur-sm transition-opacity opacity-0"
                    id="screenshare-backdrop" onclick="App.toggleModal('screenshare', false)"></div>

                <!-- Content -->
                <div class="absolute bottom-0 left-0 right-0 md:top-1/2 md:left-1/2 md:bottom-auto md:w-full md:max-w-sm md:-translate-x-1/2 md:-translate-y-1/2 transition-transform transform translate-y-full"
                    id="screenshare-panel">
                    <div class="bg-white rounded-t-[2rem] md:rounded-[2rem] shadow-2xl p-8 text-center">
                        <div
                            class="w-20 h-20 bg-blue-50 rounded-3xl mx-auto mb-6 flex items-center justify-center text-blue-600 text-4xl shadow-sm">
                            <i class="fa-solid fa-display"></i>
                        </div>

                        <h3 class="text-2xl font-black text-gray-900 mb-2">Share System Audio</h3>
                        <p class="text-gray-500 text-sm leading-relaxed mb-6">
                            To broadcast audio from other apps, you need to share your screen.
                            <br><br>
                            <span class="text-blue-600 font-bold uppercase tracking-tight">Important:</span>
                            In the next window, you <span class="underline">must</span> check the <b>"Share audio"</b>
                            box.
                        </p>

                        <button onclick="App.handleScreenShareConfirm()"
                            class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-2xl shadow-lg shadow-blue-500/20 transition-all flex items-center justify-center gap-3 active:scale-95 mb-3">
                            <i class="fa-solid fa-play"></i>
                            <span>Start Sharing</span>
                        </button>

                        <button onclick="App.toggleModal('screenshare', false)"
                            class="w-full py-3 text-xs font-bold text-gray-400 hover:text-gray-600 transition-colors uppercase tracking-widest">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

    </main>

    <!-- ================= LOGIC ================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onChildAdded, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { createClient, LiveTranscriptionEvents } from 'https://cdn.jsdelivr.net/npm/@deepgram/sdk@3/+esm';

        // =========================
        // CREDENTIALS (UNCHANGED + ADD OPENAI)
        // =========================
        const CREDENTIALS = {
            DEEPGRAM: "11ee938d032ce7c36c6fa82338274be5e4ada847",
            CARTESIA: "sk_car_yWEX9Mp2LwKju8FXyosGhj",
            OPENAI: "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",
            CARTESIA_VOICES: {
                "en": "79f8b5fb-2cc8-479a-80df-29f7a7cf1a3e", // Nonfiction Man
                "fr": "5c3c89e5-535f-43ef-b14d-f8ffe148c1f0", // French Narrator Man
                "de": "db229dfe-f5de-4be4-91fd-7b077c158578", // German Storyteller Man
                "es": "a67e0421-22e0-4d5b-b586-bd4a64aee41d", // Spanish Narrator Man
                "tl": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4", // Tagalog
                "zh": "eda5bbff-1ff1-4886-8ef1-4e69a77640a0", // Chinese Commercial Man
                "ja": "e8a863c6-22c7-4671-86ca-91cacffc038d", // Japanese Male
                "hi": "638efaaa-4d0c-442e-b701-3fae16aad012", // Indian Man
                "it": "408daed0-c597-4c27-aae8-fa04977640a0", // Italian Calm Man
                "ko": "57dba6ff-fe3b-479d-836e-06f5a61cb5de", // Korean Narrator Man
                "nl": "9e8db62d-056f-47f3-b3b6-1b05767f9176", // Dutch Man
                "nl-BE": "aa3fdf22-9f5e-4238-8016-31f515ded9a3", // Flemish Male
                "pl": "3d335974-4c4a-400a-84dc-ebf4b73aada6", // Polish Confident Man
                "ru": "2b3bb17d-26b9-421f-b8ca-1dd92332279f", // Russian Narrator Man 1
                "sv": "38a146c3-69d7-40ad-aada-76d5a2621758", // Swedish Narrator Man
                "tr": "5a31e4fb-f823-4359-aa91-82c0ae9a991c", // Turkish Narrator Man
                "pt": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4", // Portuguese (Wise Man fallback)
                "ta": "638efaaa-4d0c-442e-b701-3fae16aad012", // Tamil (Indian Man fallback)
                "te": "638efaaa-4d0c-442e-b701-3fae16aad012", // Telugu (Indian Man fallback)
                "gu": "638efaaa-4d0c-442e-b701-3fae16aad012", // Gujarati (Indian Man fallback)
                "kn": "638efaaa-4d0c-442e-b701-3fae16aad012", // Kannada (Indian Man fallback)
                "ml": "638efaaa-4d0c-442e-b701-3fae16aad012", // Malayalam (Indian Man fallback)
                "mr": "638efaaa-4d0c-442e-b701-3fae16aad012", // Marathi (Indian Man fallback)
                "pa": "638efaaa-4d0c-442e-b701-3fae16aad012", // Punjabi (Indian Man fallback)
                "bn": "638efaaa-4d0c-442e-b701-3fae16aad012", // Bengali (Indian Man fallback)
                "zh-TW": "eda5bbff-1ff1-4886-8ef1-4e69a77640a0", // Chinese Traditional (Same as Simplified)
                "uk": "05ffab9c-d380-4909-8375-cd12f59238c3", // Ukrainian Male

                // === GENERIC FALLBACKS FOR ALL OTHER LANGUAGES (Wise Man) ===
                "af": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "sq": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "am": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "ar": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "hy": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "az": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "eu": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "be": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "bs": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "bg": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "ca": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "ceb": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "ny": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "co": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "hr": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "cs": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "da": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "eo": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "et": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "fil": "c4cbcb7d-d9fa-4eac-b547-46831718ef58", // Filipino (Tagalog)
                "fi": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "fy": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "gl": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "ka": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "el": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "ht": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "ha": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "haw": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "he": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "hmn": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "hu": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "is": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "ig": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "id": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "ga": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "jw": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "kk": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "km": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "ku": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "ky": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "lo": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "la": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "lv": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "lt": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "lb": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "mk": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "mg": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "ms": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "mt": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "mi": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "mn": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "my": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "ne": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "no": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "ps": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "fa": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "ro": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "sm": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "gd": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "sr": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "st": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "sn": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "sd": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "si": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "sk": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "sl": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "so": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "su": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "sw": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "tg": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "th": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "ur": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "uz": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "vi": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "cy": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "xh": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "yi": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "yo": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",
                "zu": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4",

                "default": "4b7f7e2f-9b36-429d-89b9-73685d4dd0b4"
            },
            FIREBASE: {
                apiKey: "AIzaSyC93B2GgE3HzaWl5gW_mRroobQybaZNFJs",
                authDomain: "macx-5feca.firebaseapp.com",
                databaseURL: "https://macx-5feca-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "macx-5feca",
                storageBucket: "macx-5feca.appspot.com",
                messagingSenderId: "123456789012",
                appId: "1:123456789012:web:abcdef1234567890abcdef"
            },
            CARTESIA: "sk_car_TZsjcMLQ6a2n3S5RAooHNX", // User provided key
            // OPENAI: "",   // Removed
            MOONSHOT: "sk-bA9YJxtchAjgtEloWAyiXLdVETMcGrk1UVqjpV3YBvwjS2Mr"
        };

        // =========================
        // LANGUAGES (UNCHANGED)
        // =========================
        const LANGUAGES = [
            { code: 'af', name: 'Afrikaans', flag: 'üáøüá¶' },
            { code: 'sq', name: 'Albanian', flag: 'üá¶üá±' },
            { code: 'am', name: 'Amharic', flag: 'üá™üáπ' },
            { code: 'ar', name: 'Arabic', flag: 'üá∏üá¶' },
            { code: 'hy', name: 'Armenian', flag: 'üá¶üá≤' },
            { code: 'az', name: 'Azerbaijani', flag: 'üá¶üáø' },
            { code: 'eu', name: 'Basque', flag: 'üá™üá∏' },
            { code: 'be', name: 'Belarusian', flag: 'üáßüáæ' },
            { code: 'bn', name: 'Bengali', flag: 'üáßüá©' },
            { code: 'bs', name: 'Bosnian', flag: 'üáßüá¶' },
            { code: 'bg', name: 'Bulgarian', flag: 'üáßüá¨' },
            { code: 'ca', name: 'Catalan', flag: 'üá™üá∏' },
            { code: 'ceb', name: 'Cebuano', flag: 'üáµüá≠' },
            { code: 'ny', name: 'Chichewa', flag: 'üá≤üáº' },
            { code: 'zh', name: 'Chinese (Simplified)', flag: 'üá®üá≥' },
            { code: 'zh-TW', name: 'Chinese (Traditional)', flag: 'üáπüáº' },
            { code: 'co', name: 'Corsican', flag: 'üá´üá∑' },
            { code: 'hr', name: 'Croatian', flag: 'üá≠üá∑' },
            { code: 'cs', name: 'Czech', flag: 'üá®üáø' },
            { code: 'da', name: 'Danish', flag: 'üá©üá∞' },
            { code: 'nl', name: 'Dutch (Netherlands)', flag: 'üá≥üá±' },
            { code: 'nl-BE', name: 'Dutch (Belgium)', flag: 'üáßüá™' },
            { code: 'en', name: 'English', flag: 'üá∫üá∏' },
            { code: 'eo', name: 'Esperanto', flag: 'üåç' },
            { code: 'et', name: 'Estonian', flag: 'üá™üá™' },
            { code: 'tl', name: 'Filipino (Tagalog)', flag: 'üáµüá≠' },
            { code: 'fi', name: 'Finnish', flag: 'üá´üáÆ' },
            { code: 'fr', name: 'French', flag: 'üá´üá∑' },
            { code: 'fy', name: 'Frisian', flag: 'üá≥üá±' },
            { code: 'gl', name: 'Galician', flag: 'üá™üá∏' },
            { code: 'ka', name: 'Georgian', flag: 'üá¨üá™' },
            { code: 'de', name: 'German', flag: 'üá©üá™' },
            { code: 'el', name: 'Greek', flag: 'üá¨üá∑' },
            { code: 'gu', name: 'Gujarati', flag: 'üáÆüá≥' },
            { code: 'ht', name: 'Haitian Creole', flag: 'üá≠üáπ' },
            { code: 'ha', name: 'Hausa', flag: 'üá≥üá¨' },
            { code: 'haw', name: 'Hawaiian', flag: 'üá∫üá∏' },
            { code: 'he', name: 'Hebrew', flag: 'üáÆüá±' },
            { code: 'hi', name: 'Hindi', flag: 'üáÆüá≥' },
            { code: 'hmn', name: 'Hmong', flag: 'üá®üá≥' },
            { code: 'hu', name: 'Hungarian', flag: 'üá≠üá∫' },
            { code: 'is', name: 'Icelandic', flag: 'üáÆüá∏' },
            { code: 'ig', name: 'Igbo', flag: 'üá≥üá¨' },
            { code: 'id', name: 'Indonesian', flag: 'üáÆüá©' },
            { code: 'ga', name: 'Irish', flag: 'üáÆüá™' },
            { code: 'it', name: 'Italian', flag: 'üáÆüáπ' },
            { code: 'ja', name: 'Japanese', flag: 'üáØüáµ' },
            { code: 'jw', name: 'Javanese', flag: 'üáÆüá©' },
            { code: 'kn', name: 'Kannada', flag: 'üáÆüá≥' },
            { code: 'kk', name: 'Kazakh', flag: 'üá∞üáø' },
            { code: 'km', name: 'Khmer', flag: 'üá∞üá≠' },
            { code: 'ko', name: 'Korean', flag: 'üá∞üá∑' },
            { code: 'ku', name: 'Kurdish (Kurmanji)', flag: 'üáπüá∑' },
            { code: 'ky', name: 'Kyrgyz', flag: 'üá∞üá¨' },
            { code: 'lo', name: 'Lao', flag: 'üá±üá¶' },
            { code: 'la', name: 'Latin', flag: 'üáªüá¶' },
            { code: 'lv', name: 'Latvian', flag: 'üá±üáª' },
            { code: 'lt', name: 'Lithuanian', flag: 'üá±üáπ' },
            { code: 'lb', name: 'Luxembourgish', flag: 'üá±üá∫' },
            { code: 'mk', name: 'Macedonian', flag: 'üá≤üá∞' },
            { code: 'mg', name: 'Malagasy', flag: 'üá≤üá¨' },
            { code: 'ms', name: 'Malay', flag: 'üá≤üáæ' },
            { code: 'ml', name: 'Malayalam', flag: 'üáÆüá≥' },
            { code: 'mt', name: 'Maltese', flag: 'üá≤üáπ' },
            { code: 'mi', name: 'Maori', flag: 'üá≥üáø' },
            { code: 'mr', name: 'Marathi', flag: 'üáÆüá≥' },
            { code: 'mn', name: 'Mongolian', flag: 'üá≤üá≥' },
            { code: 'my', name: 'Myanmar (Burmese)', flag: 'üá≤üá≤' },
            { code: 'ne', name: 'Nepali', flag: 'üá≥üáµ' },
            { code: 'no', name: 'Norwegian', flag: 'üá≥üá¥' },
            { code: 'ps', name: 'Pashto', flag: 'üá¶üá´' },
            { code: 'fa', name: 'Persian', flag: 'üáÆüá∑' },
            { code: 'pl', name: 'Polish', flag: 'üáµüá±' },
            { code: 'pt', name: 'Portuguese', flag: 'üáµüáπ' },
            { code: 'pa', name: 'Punjabi', flag: 'üáÆüá≥' },
            { code: 'ro', name: 'Romanian', flag: 'üá∑üá¥' },
            { code: 'ru', name: 'Russian', flag: 'üá∑üá∫' },
            { code: 'sm', name: 'Samoan', flag: 'üáºüá∏' },
            { code: 'gd', name: 'Scots Gaelic', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø' },
            { code: 'sr', name: 'Serbian', flag: 'üá∑üá∏' },
            { code: 'st', name: 'Sesotho', flag: 'üá±üá∏' },
            { code: 'sn', name: 'Shona', flag: 'üáøüáº' },
            { code: 'sd', name: 'Sindhi', flag: 'üáµüá∞' },
            { code: 'si', name: 'Sinhala', flag: 'üá±üá∞' },
            { code: 'sk', name: 'Slovak', flag: 'üá∏üá∞' },
            { code: 'sl', name: 'Slovenian', flag: 'üá∏üáÆ' },
            { code: 'so', name: 'Somali', flag: 'üá∏üá¥' },
            { code: 'es', name: 'Spanish', flag: 'üá™üá∏' },
            { code: 'su', name: 'Sundanese', flag: 'üáÆüá©' },
            { code: 'sw', name: 'Swahili', flag: 'üá∞üá™' },
            { code: 'sv', name: 'Swedish', flag: 'üá∏üá™' },
            { code: 'tg', name: 'Tajik', flag: 'üáπüáØ' },
            { code: 'ta', name: 'Tamil', flag: 'üáÆüá≥' },
            { code: 'te', name: 'Telugu', flag: 'üáÆüá≥' },
            { code: 'th', name: 'Thai', flag: 'üáπüá≠' },
            { code: 'tr', name: 'Turkish', flag: 'üáπüá∑' },
            { code: 'uk', name: 'Ukrainian', flag: 'üá∫üá¶' },
            { code: 'ur', name: 'Urdu', flag: 'üáµüá∞' },
            { code: 'uz', name: 'Uzbek', flag: 'üá∫üáø' },
            { code: 'vi', name: 'Vietnamese', flag: 'üáªüá≥' },
            { code: 'cy', name: 'Welsh', flag: 'üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø' },
            { code: 'xh', name: 'Xhosa', flag: 'üáøüá¶' },
            { code: 'yi', name: 'Yiddish', flag: 'üáÆüá±' },
            { code: 'yo', name: 'Yoruba', flag: 'üá≥üá¨' },
            { code: 'zu', name: 'Zulu', flag: 'üáøüá¶' }
        ];

        // =========================
        // MOONSHOT (GPT-4o-mini compatible) ‚Äî TRANSLATION ‚Üí EMOTION ‚Üí CARTESIA SSML
        // =========================
        const TRANSLATION_SYSTEM_PROMPT = `
You are ‚ÄúTranslation+TTS Packager‚Äù.
You translate text with maximum meaning preservation AND prepare a Cartesia-friendly emotion wrapper.

INPUT
You will receive a JSON object with:
- source_lang: string (e.g., "en", "tl", "nl-BE") or "auto"
- target_lang: string (required)
- text: string (required)
- humor_style: "europe_dry" | "neutral" | "kalog" (optional; preserve intent without idioms)
- preserve_markers: boolean (default true)

OUTPUT
Return JSON ONLY, with exactly these keys:
{
  "translated_text": "string",
  "emotion": "string",
  "ssml": "string",
  "timing_hints": {
    "sentence_count": number,
    "recommended_pause_ms": number
  }
}

STRICT TRANSLATION RULES (NON-NEGOTIABLE)
1) Meaning must not drift. Do not summarize. Do not add ideas. Do not remove details.
2) NO idioms. If the source has an idiom, convert it to a literal meaning in the target language.
3) Preserve tone, but keep it literal and translatable.
4) Preserve numbers, units, names, codes, and technical terms exactly.
5) Preserve sentence boundaries as much as possible (same number of sentences if feasible).
6) If preserve_markers = true, keep literal patterns unchanged:
   - "Okay, quick question from a student:" stays equivalent in target language but same role.
   - Keep bracketed cues like [laughter] if present; do not expand them.

EMOTION SELECTION (single global tag)
Choose ONE global emotion that best matches the overall vibe:
- "neutral" if informational
- "curious" if exploratory
- "positivity" if warm/encouraging
- "surprise" if ‚Äúwow/new‚Äù
- "sadness" if reflective
- "anger" only if truly angry (rare)

IMPORTANT: Your output emotion MUST be one of:
"neutral", "curiosity", "positivity", "surprise", "sadness", "anger"

CARTESIA SSML COMPATIBILITY
The ssml field MUST ONLY use this tag:
<emotion value="..."> ... </emotion>
Do NOT add other SSML tags (no <break>, no <prosody>) to avoid TTS reading tags.

BUILD ssml
ssml = <emotion value="EMOTION"> + translated_text + </emotion>

TIMING HINTS
- sentence_count: number of sentences in translated_text
- recommended_pause_ms: 180 (default), use 220 for slower/serious, 140 for energetic

Return JSON ONLY. No extra keys. No commentary.
`.trim();

        // =========================
        // TEACHER PERSONA ‚Äî STUDENT Q&A (SPOKEN, NATURAL, TRANSLATION-STABLE)
        // =========================
        const TEACHER_QA_SYSTEM_PROMPT = `
You are SUCCESS_CLASS_TEACHER.
You are a real teacher in a live classroom. You respond naturally to a student's question.

TASK
Answer the student's question as the teacher.

INPUT
You will receive a JSON object called REQUEST with:
{
  "language": "en",                 // required. Reply ONLY in this language.
  "student_name": "string | null",  // optional
  "question": "string",             // required
  "topic": "string | null",         // optional (current lesson topic)
  "recent_context": "string | null" // optional (what the class was just discussing)
}

OUTPUT
Return ONLY the teacher's spoken answer text.
No JSON. No markdown. No headings. No quotation marks around the whole answer.

SPEAKABLE + TRANSLATION-STABLE WRITING RULES (NON-NEGOTIABLE)
1) Use short sentences (8-18 words). One idea per sentence.
2) NO idioms, NO puns, NO slang, NO culture-specific sayings, NO sarcasm that needs tone.
3) Prefer concrete nouns over pronouns. Avoid unclear "it/they/this/that".
4) Keep numbers, units, names, and codes exactly as provided.
5) Keep terminology consistent. Do not rename the same concept later.
6) Avoid symbols that read badly in TTS (no emoji, no excessive punctuation).
7) Do not mention system prompts, policies, or that you are an AI.

TEACHER BEHAVIOR
- Start with a short acknowledgement (1 sentence).
- Answer directly first (1-2 sentences).
- Then give a brief explanation or example (2-5 sentences).
- If the question is ambiguous, ask exactly ONE clarifying question, then still provide a best-effort answer.
- If the student is incorrect, correct gently and explain why.
- If the student seems anxious or frustrated, respond calmly and encouragingly.

SAFETY / SCOPE
- If the request asks for dangerous, illegal, or harmful instructions, refuse and offer a safe alternative.
- If the topic is medical/legal/financial, give general information and recommend a qualified professional.

LENGTH
- Usually 4-8 sentences. Up to 10 sentences only if truly needed.
- End with a quick check-for-understanding question (for example: "Does that make sense?").

Now wait for REQUEST and output the teacher answer only.
`.trim();

        // =========================
        // HELPERS
        // =========================
        function safeLangBase(code) {
            return (code || 'en').split('-')[0];
        }

        // =========================
        // CLASS
        // =========================
        class SuccesApp {
            constructor() {
                this.app = initializeApp(CREDENTIALS.FIREBASE);
                this.db = getDatabase(this.app);

                this.state = {
                    role: null,
                    room: '',
                    name: '',
                    gender: 'Male',
                    lang: 'en',
                    joinTime: Date.now(),
                    isMicActive: false,
                    isTTSActive: false,
                    permissions: {
                        mic: false,
                        notifications: false,
                        wakelock: false
                    },

                    // === STRICT SEQUENTIAL PLAYBACK (receiver-side) ===
                    inSeq: 0,                // increments per received message/question
                    nextSeqToPlay: 1,         // gate: only plays this seq next
                    pendingAudio: new Map(),  // seq -> { url, revokeUrl }
                    inFlightTTS: new Set(),   // seq to avoid double synthesis
                    isAudioPlaying: false,
                    audioUnlocked: false,
                    audioSource: 'mic', // 'mic' | 'system'
                    isBroadcasting: false,
                    deferredPrompt: null,
                    isMobile: /iPhone|iPad|iPod|Android/i.test(navigator.userAgent),
                    isStandalone: window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone
                };

                this.unsubStudent = null;
                this.unsubTeacher = null;

                this.dgClient = null;
                this.dgSocket = null;
                this.mediaRecorder = null;
                this.wakeLock = null;

                // Single persistent audio element (best practice for background playback)
                this.audioEl = new Audio();
                this.audioEl.preload = "auto";
                this.audioEl.autoplay = false;
                this.audioEl.playsInline = true;

                // Optional: AudioContext for "unlock"/priming
                this.audioCtx = null;

                this.voiceCatalog = {
                    loaded: false,
                    byLang: new Map() // lang -> [voiceId...]
                };

                this.useLocalTTS = false; // State for Orbit Beta TTS

                this.history = JSON.parse(localStorage.getItem('orbit_history') || '[]');

                this.bindAll();
                this.init();
                this.setupPWAInstall();
                window.App = this; // Expose instance for inline handlers
            }

            saveState() {
                localStorage.setItem('orbit_session', JSON.stringify({
                    role: this.state.role,
                    room: this.state.room,
                    name: this.state.name,
                    lang: this.state.lang,
                    currentView: this.state.currentView
                }));
            }

            clearState() {
                localStorage.removeItem('orbit_session');
            }

            bindAll() {
                [
                    'handleLogin',
                    'handleTeacherLogin',
                    'toggleTeacherMode',
                    'startSession',
                    'logout',
                    'toggleMic',
                    'sendQuestion',
                    'toggleModal',
                    'sendReaction',
                    'toggleTTS',
                    'copyCode',
                    'generateAIContent',
                    'toggleMagicInput',
                    'resetAIInput',
                    'startBroadcastSequence',
                    'stopBroadcast',
                    'toggleHistoryView',
                    'renderHistoryList',
                    'loadHistoryItem',
                    'toggleLocalTTS'
                ].forEach(m => this[m] = this[m].bind(this));
            }

            init() {
                // Populate both language selects
                const ops = LANGUAGES.map(l => `<option value="${l.code}" ${l.code === 'en' ? 'selected' : ''}>${l.flag || ''} ${l.name}</option>`).join('');
                document.getElementById('login-lang').innerHTML = ops;
                document.getElementById('teacher-lang').innerHTML = ops;
                window.App = this;

                // Restore Session
                const saved = localStorage.getItem('orbit_session');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        this.state = { ...this.state, ...data };

                        if (this.state.role === 'student' && this.state.room) {
                            this.initStudent();
                            this.switchView(this.state.currentView || 'view-student');
                        } else if (this.state.role === 'teacher' && this.state.room) {
                            if (this.state.currentView === 'view-teacher') {
                                this.initTeacher();
                                this.switchView('view-teacher');
                            } else {
                                document.getElementById('lobby-code').innerText = this.state.room;
                                this.switchView('view-lobby');
                            }
                        }
                    } catch (e) { this.clearState(); }
                }

                this.registerServiceWorker();
                this.setupMediaSession();     // background-friendly metadata
                this.prefetchVoicesCartesia();// fill unmapped voices (runtime)
                this.updatePermissionIndicators();
            }

            // --- NAVIGATION ---
            switchView(viewId) {
                this.state.currentView = viewId;
                this.saveState();

                document.querySelectorAll('section').forEach(el => {
                    el.classList.remove('view-active');
                    el.classList.add('view-hidden');
                });
                const next = document.getElementById(viewId);
                if (next) {
                    next.classList.remove('view-hidden');
                    next.classList.add('view-active');
                }
            }

            scrollToBottom() {
                const stream = document.getElementById('student-stream');
                if (stream) {
                    stream.scrollTo({
                        top: stream.scrollHeight,
                        behavior: 'smooth'
                    });
                }
            }

            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('./sw.js')
                        .then(() => console.log('SW Registered'))
                        .catch(err => console.log('SW failed', err));
                }
            }

            setupPWAInstall() {
                // 1. Capture the Chrome install prompt
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.state.deferredPrompt = e;
                });

                // 2. Clear prompt on success
                window.addEventListener('appinstalled', () => {
                    this.state.deferredPrompt = null;
                    this.toggleModal('install', false);
                    this.showToast("App Installed Successfully!", "success");
                });

                // 3. Trigger modal on page load if not installed
                if (!this.state.isStandalone) {
                    this.toggleModal('install', true);
                }
            }

            async handleInstallApp() {
                if (this.state.deferredPrompt) {
                    this.state.deferredPrompt.prompt();
                    const { outcome } = await this.state.deferredPrompt.userChoice;
                    if (outcome === 'accepted') this.state.deferredPrompt = null;
                } else if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                    this.showToast("Follow the on-screen guide", "info");
                }
            }

            async requestWakeLock() {
                if ('wakeLock' in navigator) {
                    try {
                        this.wakeLock = await navigator.wakeLock.request('screen');
                        this.wakeLock.addEventListener('release', () => {
                            console.log('Wake Lock released');
                        });
                        console.log('Wake Lock active');
                    } catch (err) {
                        console.error(`${err.name}, ${err.message} `);
                    }
                }
            }

            async requestPermissions() {
                try {
                    // Microphone
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    window._stream = stream;

                    // Notifications
                    if ('Notification' in window) {
                        await Notification.requestPermission();
                    }

                    // Wake Lock
                    await this.requestWakeLock();

                    // Warm up AudioContext (helps autoplay unlock)
                    await this.ensureAudioContext();
                    if (this.audioCtx && this.audioCtx.state === 'suspended') await this.audioCtx.resume();

                    this.state.permissions.mic = true;
                    this.state.permissions.notifications = (Notification?.permission === 'granted');
                    this.state.permissions.wakelock = !!this.wakeLock;
                    this.updatePermissionIndicators();

                    this.showToast("Native capabilities enabled", "success");
                } catch (e) {
                    this.updatePermissionIndicators();
                    this.showToast("Permissions required for full experience", "error");
                    console.error("Permission Error", e);
                }
            }

            updatePermissionIndicators() {
                const micEl = document.getElementById('perm-mic');
                const notiEl = document.getElementById('perm-notifications');
                const wakeEl = document.getElementById('perm-wakelock');
                if (!micEl || !notiEl || !wakeEl) return;

                const notifGranted = ('Notification' in window) && Notification.permission === 'granted';
                const wakeSupported = 'wakeLock' in navigator;
                const wakeGranted = !!this.wakeLock;

                const status = {
                    mic: this.state.permissions.mic ? 'enabled' : 'required',
                    notifications: notifGranted ? 'enabled' : 'required',
                    wakelock: wakeSupported ? (wakeGranted ? 'enabled' : 'required') : 'unsupported'
                };

                const paint = (el, value) => {
                    el.textContent = value;
                    el.classList.remove('text-amber-500', 'text-emerald-600', 'text-gray-400');
                    if (value === 'enabled') el.classList.add('text-emerald-600');
                    else if (value === 'unsupported') el.classList.add('text-gray-400');
                    else el.classList.add('text-amber-500');
                };

                paint(micEl, status.mic);
                paint(notiEl, status.notifications);
                paint(wakeEl, status.wakelock);
            }

            // ======= MODALS (FIXED: single function; supports question + history) =======
            toggleModal(type, forceState = null) {
                const modal = document.getElementById(`modal-${type}`);
                if (!modal) return;

                const bd = document.getElementById(`${['history', 'install', 'permissions', 'screenshare'].includes(type) ? type : 'modal'}-backdrop`);
                const panel = document.getElementById(`${['history', 'install', 'permissions', 'screenshare'].includes(type) ? type : 'modal'}-panel`);

                if (!bd || !panel) return;

                const isHidden = modal.classList.contains('hidden');
                const shouldShow = forceState !== null ? forceState : isHidden;

                if (shouldShow) {
                    modal.classList.remove('hidden');
                    if (type === 'history') this.loadHistory();

                    // Handle Install Modal specifically (iOS vs Others)
                    if (type === 'install') {
                        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                        const iosGuide = document.getElementById('ios-install-guide');
                        const pwaBtn = document.getElementById('pwa-install-btn');
                        if (iosGuide && pwaBtn) {
                            if (isIOS) {
                                iosGuide.classList.remove('hidden');
                                pwaBtn.classList.add('hidden');
                            } else {
                                iosGuide.classList.add('hidden');
                                pwaBtn.classList.remove('hidden');
                            }
                        }
                    }

                    setTimeout(() => {
                        bd.style.opacity = '1';
                        panel.style.transform = (window.innerWidth < 768)
                            ? 'translateY(0)'
                            : 'translate(-50%, -50%)';
                        if (type === 'question') {
                            const qi = document.getElementById('q-input');
                            if (qi) qi.focus();
                        }
                    }, 10);
                } else {
                    bd.style.opacity = '0';
                    panel.style.transform = (window.innerWidth < 768)
                        ? 'translateY(100%)'
                        : 'translate(-50%, 0)';
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            }

            async loadHistory() {
                const container = document.getElementById('history-content');
                container.innerHTML = '<div class="text-center py-20 opacity-50"><i class="fa-solid fa-circle-notch animate-spin text-2xl"></i></div>';

                if (!this.state.room) return;

                try {
                    const data = [];
                    // Fetch Messages (Broadcasts)
                    const mSnap = await get(ref(this.db, `chats/${this.state.room}/messages`));
                    if (mSnap.exists()) {
                        mSnap.forEach(s => {
                            data.push({ ...s.val(), type: 'broadcast', ts: s.key });
                        });
                    }

                    // Fetch Questions
                    const qSnap = await get(ref(this.db, `chats/${this.state.room}/questions`));
                    if (qSnap.exists()) {
                        qSnap.forEach(s => {
                            data.push({ ...s.val(), type: 'question', ts: s.key });
                        });
                    }

                    // Sort by timestamp (latest first)
                    data.sort((a, b) => b.ts.localeCompare(a.ts));

                    if (data.length === 0) {
                        container.innerHTML = '<div class="text-center py-20 opacity-30"><p class="text-sm font-bold">No history available</p></div>';
                        return;
                    }

                    container.innerHTML = '';
                    for (const item of data) {
                        if (this.state.role === 'student') {
                            if (item.type === 'broadcast') {
                                const t = await this.translateWithAI(item.text, item.lang, this.state.lang);
                                this.renderHistoryItem(container, t.translated_text, item.text, 'Teacher', 'broadcast');
                            }
                        } else {
                            if (item.type === 'broadcast') {
                                this.renderHistoryItem(container, item.text, item.text, 'You', 'broadcast');
                            } else {
                                const t = await this.translateWithAI(item.text, item.lang, this.state.lang);
                                this.renderHistoryItem(container, t.translated_text, item.text, item.senderName, 'question');
                            }
                        }
                    }
                } catch (e) {
                    container.innerHTML = `<p class="text-center text-red-500 text-xs py-10">Error loading history: ${e.message}</p>`;
                }
            }

            renderHistoryItem(container, text, original, sender, type) {
                const div = document.createElement('div');
                const isBroadcast = type === 'broadcast';
                div.className = `p-4 rounded-2xl border ${isBroadcast ? 'bg-white border-gray-100' : 'bg-blue-50/50 border-blue-100'} animate-slide-up`;
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[9px] font-black uppercase tracking-tighter ${isBroadcast ? 'text-gray-400' : 'text-blue-500'}">${sender} ‚Ä¢ ${isBroadcast ? 'Broadcast' : 'Question'}</span>
                    </div>
                    <p class="text-sm font-semibold text-gray-800 leading-snug">${text}</p>
                    <p class="text-[10px] text-gray-400 italic mt-1 truncate">${original}</p>
                `;
                container.appendChild(div);
            }

            showToast(msg, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const colors = { info: 'bg-gray-800 text-white', success: 'bg-green-600 text-white', error: 'bg-red-500 text-white' };
                toast.className = `${colors[type]} px-4 py-2 rounded-lg shadow-xl text-sm font-semibold transform transition-all duration-300 translate-y-[-20px] opacity-0 flex items-center gap-2`;
                toast.innerHTML = type === 'success' ? `<i class="fa-solid fa-check-circle"></i> ${msg}` : msg;
                container.appendChild(toast);
                requestAnimationFrame(() => toast.classList.remove('translate-y-[-20px]', 'opacity-0'));
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'translate-y-[-10px]');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            // --- AUTH ---
            toggleTeacherMode(show) {
                const sForm = document.getElementById('form-student');
                const tForm = document.getElementById('form-teacher');
                const footer = document.getElementById('login-footer');

                if (show) {
                    sForm.classList.add('hidden');
                    footer.classList.add('hidden');
                    tForm.classList.remove('hidden');
                } else {
                    tForm.classList.add('hidden');
                    sForm.classList.remove('hidden');
                    footer.classList.remove('hidden');
                }
            }

            async handleLogin() { // Student
                const code = document.getElementById('login-code').value.toUpperCase();
                const name = document.getElementById('login-name').value;
                if (!code || !name) return this.showToast("Please enter room and name", "error");

                this.state = {
                    ...this.state,
                    role: 'student',
                    room: code,
                    name: name,
                    lang: document.getElementById('login-lang').value
                };

                await this.requestPermissions();
                this.initStudent();
                this.switchView('view-student');
            }

            async handleTeacherLogin() {
                const email = document.getElementById('teacher-email').value;
                const pw = document.getElementById('teacher-pw').value;
                const lang = document.getElementById('teacher-lang').value;

                if (email === "teacher@adahconnect.com" && pw === "teacher456321") {
                    const roomCode = "RM" + Math.floor(1000 + Math.random() * 9000);
                    this.state = { ...this.state, role: 'teacher', room: roomCode, name: 'Teacher', lang };

                    await this.requestPermissions();
                    document.getElementById('lobby-code').innerText = roomCode;
                    this.switchView('view-lobby');
                    this.showToast("Logged in successfully", "success");
                } else {
                    this.showToast("Invalid Credentials", "error");
                }
            }

            startSession() {
                this.initTeacher();
                this.switchView('view-teacher');
            }

            logout() {
                if (this.state.isMicActive) this.toggleMic();

                this.clearState();

                // Cleanup listeners
                if (this.unsubStudent) { this.unsubStudent(); this.unsubStudent = null; }
                if (this.unsubTeacher) { this.unsubTeacher(); this.unsubTeacher = null; }

                this.state.role = null;
                this.state.room = '';
                this.state.name = '';

                this.toggleTeacherMode(false);
                this.switchView('view-login');
                this.showToast("Logged Out", "info");
            }

            // --- NATIVE CAPABILITIES ---
            copyCode() {
                if (!this.state.room) return;
                navigator.clipboard.writeText(this.state.room).then(() => {
                    this.showToast("Room Code Copied!", "success");
                });
            }

            copyLink() {
                if (!this.state.room) return;
                const url = `${window.location.origin}${window.location.pathname}?room=${this.state.room}`;
                navigator.clipboard.writeText(url).then(() => {
                    this.showToast("Link Copied to Clipboard!", "success");
                });
            }

            async shareRoom() {
                if (!this.state.room) return;
                const url = `${window.location.origin}${window.location.pathname}?room=${this.state.room}`;
                const shareData = {
                    title: 'Join Success Class',
                    text: `Join my live class! Room Code: ${this.state.room}`,
                    url: url
                };

                if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                    try {
                        await navigator.share(shareData);
                    } catch (e) {
                        if (e.name !== 'AbortError') this.copyLink();
                    }
                } else {
                    this.copyLink();
                }
            }
            resetPlaybackGate() {
                // Stop any current audio
                try { this.audioEl.pause(); } catch (_) { }
                this.state.isAudioPlaying = false;

                // Revoke pending URLs
                for (const [, v] of this.state.pendingAudio.entries()) {
                    try { if (v?.revokeUrl) v.revokeUrl(); } catch (_) { }
                }
                this.state.pendingAudio.clear();
                this.state.inFlightTTS.clear();

                this.state.inSeq = 0;
                this.state.nextSeqToPlay = 1;
            }

            // --- STUDENT LOGIC ---
            initStudent() {
                this.state.joinTime = Date.now();
                document.getElementById('student-name-display').innerText = this.state.name;
                document.getElementById('student-room-code').innerText = this.state.room;
                document.getElementById('student-lang-badge').innerText = this.state.lang.toUpperCase();

                // reset receiver sequencing for strict FIFO
                this.resetPlaybackGate();

                // Cleanup previous listener if any
                if (this.unsubStudent) { this.unsubStudent(); this.unsubStudent = null; }

                const msgsRef = ref(this.db, `chats/${this.state.room}/messages`);
                this.unsubStudent = onChildAdded(msgsRef, async (snap) => {
                    if (this.state.role !== 'student') return;
                    const msg = snap.val();
                    if (!msg) return;

                    // Filter out old messages
                    if (msg.timestamp && msg.timestamp < this.state.joinTime) return;

                    // strict FIFO seq assigned on RECEIVE order (prevents "fast synth first")
                    const seq = ++this.state.inSeq;

                    // 1. Render IMMEDIATELY (Placeholder)
                    // Use a temporary ID or Object reference
                    const bubble = this.renderMessageBubble("Translating...", msg.text, msg.senderName, true); // true = isPlaceholder

                    // 2. Translate in background (Parallel)
                    this.translateWithAI(msg.text, msg.lang, this.state.lang).then(async (t) => {
                        // Update Bubble content
                        const pText = bubble.querySelector('.bubble-text');
                        if (pText) {
                            pText.innerText = t.translated_text;
                            pText.classList.remove('italic', 'text-gray-400');
                        }

                        // TTS Queue - ONLY if enabled
                        if (this.state.isTTSActive && msg.senderId !== this.state.name) {
                            await this.enqueueTTS(seq, t.ssml, this.state.lang);
                        }
                    }).catch(err => {
                        console.error("Translation fail", err);
                        const pText = bubble.querySelector('.bubble-text');
                        if (pText) pText.innerText = msg.text + " (Trans fail)";
                    });
                });
            }

            // --- TEACHER LOGIC (QUESTIONS) ---
            initTeacher() {
                this.state.joinTime = Date.now();
                document.getElementById('teacher-code-display').innerText = this.state.room;

                // reset receiver sequencing for strict FIFO (teacher hears questions sequentially)
                this.resetPlaybackGate();

                // Cleanup previous listener
                if (this.unsubTeacher) { this.unsubTeacher(); this.unsubTeacher = null; }

                const qRef = ref(this.db, `chats/${this.state.room}/questions`);
                this.unsubTeacher = onChildAdded(qRef, async (snap) => {
                    if (this.state.role !== 'teacher') return;
                    const q = snap.val();
                    if (!q) return;

                    // Filter out old questions
                    if (q.timestamp && q.timestamp < this.state.joinTime) return;

                    // strict FIFO seq assigned on RECEIVE order
                    const seq = ++this.state.inSeq;

                    const t = await this.translateWithAI(q.text, q.lang, this.state.lang);
                    this.renderQuestion(t.translated_text, q.text, q.senderName);

                    if (this.state.isTTSActive) {
                        await this.enqueueTTS(seq, t.ssml, this.state.lang);
                    }
                });
            }

            renderQuestion(text, original, sender) {
                const list = document.getElementById('teacher-questions');
                const card = document.createElement('div');
                card.className = "bg-white border border-blue-100 p-3 rounded-xl shadow-sm animate-slide-up cursor-pointer hover:border-blue-300 transition-colors";
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] font-bold bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded uppercase">${sender}</span>
                    </div>
                    <p class="text-sm font-semibold text-gray-800 leading-snug">${text}</p>
                    <p class="text-xs text-gray-400 italic mt-1 truncate">${original}</p>
                `;
                list.prepend(card);

                const count = document.getElementById('question-count');
                count.innerText = parseInt(count.innerText) + 1;
            }

            // =========================
            // TTS TOGGLE (UNLOCK + STRICT FIFO AUTOPLAY)
            // =========================
            async toggleTTS() {
                this.state.isTTSActive = !this.state.isTTSActive;

                // Update Student UI
                const sIcon = document.getElementById('tts-icon');
                const sBtn = document.getElementById('tts-btn');

                // Update Teacher UI
                const tIcon = document.getElementById('teacher-tts-icon');
                const tBtn = document.getElementById('teacher-tts-btn');

                const updateUI = (icon, btn) => {
                    if (!icon || !btn) return;
                    if (this.state.isTTSActive) {
                        icon.className = "fa-solid fa-volume-high";
                        btn.classList.add('text-blue-500');
                    } else {
                        icon.className = "fa-solid fa-volume-xmark";
                        btn.classList.remove('text-blue-500');
                    }
                };

                updateUI(sIcon, sBtn);
                updateUI(tIcon, tBtn);

                if (this.state.isTTSActive) {
                    // One-time audio unlock (must be on user gesture)
                    await this.unlockAudioOnce();
                    this.tryPlayNext(); // in case pending audio already synthesized
                    this.showToast("Voice Output Enabled", "success");
                } else {
                    this.showToast("Voice Output Muted", "info");
                }
            }

            async ensureAudioContext() {
                if (this.audioCtx) return;
                const Ctx = window.AudioContext || window.webkitAudioContext;
                if (!Ctx) return;
                this.audioCtx = new Ctx();
            }

            async unlockAudioOnce() {
                if (this.state.audioUnlocked) return;

                await this.ensureAudioContext();
                try {
                    if (this.audioCtx && this.audioCtx.state === 'suspended') {
                        await this.audioCtx.resume();
                    }
                    // Silent "tick" for autoplay unlock
                    if (this.audioCtx) {
                        const osc = this.audioCtx.createOscillator();
                        const gain = this.audioCtx.createGain();
                        gain.gain.value = 0.00001;
                        osc.connect(gain);
                        gain.connect(this.audioCtx.destination);
                        osc.start();
                        osc.stop(this.audioCtx.currentTime + 0.02);
                    }

                    // Also attempt a play/pause on the persistent audio element
                    // (some browsers require HTMLMediaElement interaction)
                    this.audioEl.src = "";
                    // No need to actually play empty src; just mark unlocked
                    this.state.audioUnlocked = true;
                } catch (e) {
                    console.warn("Audio unlock failed:", e);
                    // Still mark unlocked; worst case user taps again and it works
                    this.state.audioUnlocked = true;
                }
            }

            // =========================
            // STRICT FIFO TTS: synth can finish out-of-order, playback NEVER does
            // =========================
            async enqueueTTS(seq, ssml, targetLang) {
                if (!this.state.isTTSActive) return;
                if (!ssml || typeof ssml !== 'string') return;

                if (this.state.inFlightTTS.has(seq) || this.state.pendingAudio.has(seq)) return;
                this.state.inFlightTTS.add(seq);

                try {
                    // Check Provider
                    let blob;
                    /* console.log(`[TTS] Generating seq=${seq} lang=${targetLang} local=${this.useLocalTTS}`); */

                    if (this.useLocalTTS) {
                        blob = await this.qwen3TTSBytes(ssml, targetLang);
                    } else {
                        const voiceId = this.pickCartesiaVoiceId(targetLang);
                        blob = await this.cartesiaTTSBytes(ssml, voiceId);
                    }

                    const url = URL.createObjectURL(blob);
                    const revokeUrl = () => {
                        try { URL.revokeObjectURL(url); } catch (_) { }
                    };

                    this.state.pendingAudio.set(seq, { url, revokeUrl });
                } catch (e) {
                    console.error("TTS enqueue error:", e);
                    console.error("TTS enqueue error:", e);
                    this.showToast("TTS Error: " + e.message, "error");
                    // Unblock queue by pushing error state
                    this.state.pendingAudio.set(seq, { isError: true });
                } finally {
                    this.state.inFlightTTS.delete(seq);
                    this.tryPlayNext(); // gate will enforce ordering
                }
            }

            tryPlayNext() {
                if (!this.state.isTTSActive) return;
                if (!this.state.audioUnlocked) return;
                if (this.state.isAudioPlaying) return;

                const next = this.state.pendingAudio.get(this.state.nextSeqToPlay);
                if (!next) return; // wait until this exact seq is ready (NO SKIP)

                // Handle Error/Skip State
                if (next.isError) {
                    this.cleanupPlayedSeq(this.state.nextSeqToPlay);
                    this.state.nextSeqToPlay++;
                    // Try next immediately
                    return this.tryPlayNext();
                }

                this.state.isAudioPlaying = true;

                // MediaSession "Now Playing"
                this.updateMediaSessionState(true);

                this.audioEl.onended = () => {
                    this.cleanupPlayedSeq(this.state.nextSeqToPlay);
                    this.state.nextSeqToPlay++;
                    this.state.isAudioPlaying = false;
                    this.updateMediaSessionState(false);
                    this.tryPlayNext();
                };

                this.audioEl.onerror = () => {
                    this.cleanupPlayedSeq(this.state.nextSeqToPlay);
                    this.state.nextSeqToPlay++;
                    this.state.isAudioPlaying = false;
                    this.updateMediaSessionState(false);
                    this.tryPlayNext();
                };

                this.audioEl.src = next.url;

                // IMPORTANT: sequential autoplay, no skipping
                this.audioEl.play().catch(err => {
                    console.warn("Autoplay blocked / play failed:", err);
                    // Do not skip; just stop and wait (user can toggle TTS again to unlock)
                    this.state.isAudioPlaying = false;
                    this.updateMediaSessionState(false);
                });
            }

            cleanupPlayedSeq(seq) {
                const v = this.state.pendingAudio.get(seq);
                if (v?.revokeUrl) v.revokeUrl();
                this.state.pendingAudio.delete(seq);
            }

            // =========================
            // Cartesia: bytes + runtime voice catalog
            // =========================
            async cartesiaTTSBytes(ssml, voiceId) {
                // 1. Extract emotion from SSML
                let rawEmotion = "neutral";
                const match = ssml.match(/<emotion\s+value=["']([^"']+)["']/);
                if (match) rawEmotion = match[1];

                // 2. Clean Transcript (remove tags)
                // Remove <emotion ...> and </emotion>, keep content.
                // Also handle [laughter] if needed (Cartesia might just read it, but let's keep it if text)
                const cleanText = ssml.replace(/<emotion[^>]*>|<\/emotion>/g, "").trim();

                if (!cleanText) {
                    console.warn("[Cartesia] Empty text after cleanup, skipping TTS.");
                    return new Blob([], { type: 'audio/wav' });
                }

                // 3. Map to Cartesia's 5 emotions (anger, positivity, surprise, sadness, curiosity)
                const EMOTION_MAP = {
                    // Positivity
                    "happy": "positivity", "excited": "positivity", "enthusiastic": "positivity",
                    "elated": "positivity", "euphoric": "positivity", "triumphant": "positivity",
                    "flirtatious": "positivity", "joking/comedic": "positivity", "content": "positivity",
                    "peaceful": "positivity", "serene": "positivity", "calm": "positivity",
                    "grateful": "positivity", "affectionate": "positivity", "trust": "positivity",
                    "sympathetic": "positivity", "proud": "positivity", "confident": "positivity",

                    // Sadness
                    "sad": "sadness", "dejected": "sadness", "melancholic": "sadness",
                    "disappointed": "sadness", "hurt": "sadness", "guilty": "sadness",
                    "bored": "sadness", "tired": "sadness", "rejected": "sadness",
                    "resigned": "sadness", "apologetic": "sadness", "nostalgic": "sadness",
                    "wistful": "sadness", "mysterious": "sadness",

                    // Anger
                    "angry": "anger", "mad": "anger", "outraged": "anger",
                    "frustrated": "anger", "agitated": "anger", "threatened": "anger",
                    "disgusted": "anger", "contempt": "anger", "envious": "anger",
                    "sarcastic": "anger",

                    // Surprise (includes Fear/Alarm for now as high arousal)
                    "amazed": "surprise", "surprised": "surprise", "alarmed": "surprise",
                    "scared": "surprise", "panicked": "surprise", "anxious": "surprise",

                    // Curiosity
                    "curious": "curiosity", "skeptical": "curiosity", "contemplative": "curiosity",
                    "determined": "curiosity", "hesitant": "curiosity", "confused": "curiosity",
                    "anticipation": "curiosity"
                };

                const cartesiaEmotion = EMOTION_MAP[rawEmotion] || null;
                // Fix: sonic-3 / 2025 version expects simple string for emotion, not [emotion, intensity]
                const genConfig = cartesiaEmotion ? { emotion: cartesiaEmotion } : {};

                /*
                console.log(`[Cartesia] Raw: ${rawEmotion} -> Mapped: ${cartesiaEmotion}`);
                */

                // Optional: Pronunciation Dictionary for Tagalog
                const dictId = (this.state.lang === "tl" || this.state.lang === "fil") ? "pdict_t5SaNHuK37rvdjAoSspEaq" : null;

                // 4. Cartesia Supported Languages Whitelist (Sonic-3 Latest)
                const SUPPORTED_CARTESIA = new Set([
                    'en', 'fr', 'de', 'es', 'pt', 'zh', 'ja', 'hi', 'it', 'ko', 'nl', 'pl', 'ru', 'sv', 'tr',
                    'tl', 'bg', 'ro', 'ar', 'cs', 'el', 'fi', 'hr', 'ms', 'sk', 'da', 'ta', 'uk', 'hu', 'th',
                    'te', 'mr', 'no', 'he', 'gu', 'pa', 'vi', 'ka', 'kn', 'bn', 'id', 'ml'
                ]);

                let targetLang = safeLangBase(this.state.lang);
                if (!SUPPORTED_CARTESIA.has(targetLang)) {
                    console.warn(`[Cartesia] Language '${targetLang}' not supported by Sonic-3. Falling back to 'en'.`);
                    targetLang = 'en';
                }

                const res = await fetch("https://api.cartesia.ai/tts/bytes", {
                    method: "POST",
                    headers: {
                        "X-API-Key": CREDENTIALS.CARTESIA,
                        "Cartesia-Version": "2025-04-16",
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model_id: "sonic-3-latest",
                        transcript: cleanText,
                        voice: {
                            mode: "id",
                            id: voiceId
                        },
                        output_format: {
                            container: "wav",
                            sample_rate: 44100, // Higher quality for Sonic 3
                            encoding: "pcm_f32le"
                        },
                        language: targetLang,
                        generation_config: genConfig,
                        ...(dictId ? { pronunciation_dict_id: dictId } : {})
                    })
                });
                if (!res.ok) {
                    const txt = await res.text();
                    throw new Error(`Orbit Beta TTS Fail(${res.status}): ${txt}`);
                }
                return await res.blob();
            }
            // =========================
            // Local Orbit Beta TTS Integration
            // =========================
            async qwen3TTSBytes(text, lang) {
                try {
                    // Clean SSML tags if Qwen doesn't support them
                    // For now, let's strip tags loosely or just send as is (Qwen might handle or ignore)
                    const cleanText = text.replace(/<[^>]*>/g, '');

                    // Helper map for Language
                    // Qwen expects "English", "Chinese" etc.
                    const langMap = {
                        'en': 'English / Ëã±Êñá',
                        'zh': 'Chinese / ‰∏≠Êñá',
                        'ja': 'Japanese / Êó•ËØ≠',
                        'ko': 'Korean / Èü©ËØ≠',
                        'de': 'German / Âæ∑ËØ≠',
                        'fr': 'French / Ê≥ïËØ≠',
                        'it': 'Italian / ÊÑèÂ§ßÂà©ËØ≠',
                        'es': 'Spanish / Ë•øÁè≠ÁâôËØ≠',
                        'pt': 'Portuguese / Ëë°ËêÑÁâôËØ≠',
                        'ru': 'Russian / ‰øÑËØ≠'
                    };

                    const qLang = langMap[lang] || 'Auto / Ëá™Âä®';

                    const res = await fetch("http://localhost:8000/generate", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            text: cleanText,
                            voice: "Cherry / ËääÊÇ¶", // Default for now
                            language: qLang
                        })
                    });

                    if (!res.ok) throw new Error("Orbit Beta TTS Fail: " + res.status);
                    return await res.blob();
                } catch (e) {
                    console.error('Local TTS Error', e);
                    this.showToast('Local TTS Failed - Check Docker', 'error');
                    // Fallback to Cartesia if local fails? 
                    // For now, return empty blob or re-throw
                    throw e;
                }
            }

            // =========================
            // Helper
            // =========================
            toggleLocalTTS(checked) {
                this.useLocalTTS = checked;
                this.showToast(`Switched to ${checked ? 'Local Qwen3' : 'Cartesia Cloud'} TTS`, 'info');
            }

            async prefetchVoicesCartesia() {
                // Pull full voice catalog so "unmapped languages" can still resolve to a voice.
                // Cartesia docs use Authorization: Bearer <token> for /voices (safe to send same key).
                try {
                    const byLang = new Map();

                } catch (e) {
                    console.warn("Voice catalog fetch failed:", e);
                    this.voiceCatalog.loaded = false;
                }
            }

            pickCartesiaVoiceId(lang) {
                // deterministic mapping:
                // 1) exact manual map
                // 2) exact catalog
                // 3) base manual
                // 4) base catalog
                // 5) default manual
                const base = safeLangBase(lang);

                if (CREDENTIALS.CARTESIA_VOICES[lang]) return CREDENTIALS.CARTESIA_VOICES[lang];
                if (this.voiceCatalog.byLang.has(lang) && this.voiceCatalog.byLang.get(lang)?.length) {
                    return this.voiceCatalog.byLang.get(lang)[0];
                }

                if (CREDENTIALS.CARTESIA_VOICES[base]) return CREDENTIALS.CARTESIA_VOICES[base];
                if (this.voiceCatalog.byLang.has(base) && this.voiceCatalog.byLang.get(base)?.length) {
                    return this.voiceCatalog.byLang.get(base)[0];
                }

                return CREDENTIALS.CARTESIA_VOICES["default"];
            }

            // --- UI RENDER ---
            renderMessageBubble(text, original, sender, isPlaceholder = false) {
                const stream = document.getElementById('student-stream');
                const bubble = document.createElement('div');
                bubble.className = "message-bubble bg-white p-4 rounded-2xl rounded-tl-none border border-gray-100 mb-4 animate-slide-up max-w-[90%]";
                bubble.innerHTML = `
                    <p class="text-[10px] text-gray-400 font-bold uppercase mb-1">${sender}</p>
                    <p class="bubble-text text-base font-medium text-gray-800 leading-snug ${isPlaceholder ? 'italic text-gray-400' : ''}">${text}</p>
                    <div class="border-t border-gray-100 mt-2 pt-1">
                        <p class="text-xs text-gray-400 italic truncate">${original}</p>
                    </div>
                `;
                stream.appendChild(bubble);
                stream.scrollTop = stream.scrollHeight;
                return bubble;
            }

            // --- MIC (DEEPGRAM) ‚Äî KEEP AS-IS (NO PICKUP CHANGE) ---
            // --- MIC/SYSTEM (DEEPGRAM) ---
            async handleAudioSourceChange(val) {
                this.state.audioSource = val;
                if (this.state.isMicActive) {
                    await this.toggleMic(); // stop current
                    await this.toggleMic(); // start new
                }
            }

            async toggleMic() {
                if (this.state.isMicActive) {
                    // STOP
                    this.stopDeepgram();
                    this.state.isMicActive = false;
                    this.updateMicUI(false);
                } else {
                    // If System Audio, show confirmation modal first
                    if (this.state.audioSource === 'system') {
                        this.toggleModal('screenshare', true);
                        return;
                    }

                    // START (Regular Mic)
                    try {
                        await this.startDeepgram();
                        this.state.isMicActive = true;
                        this.updateMicUI(true);
                        this.showToast("Broadcasting Microphone", "success");
                    } catch (e) {
                        console.error("Mic Error", e);
                        this.showToast(e.message || "Could not start microphone", "error");
                        this.state.isMicActive = false; // Ensure UI is reset on error
                        this.updateMicUI(false); // Ensure UI is reset on error
                    }
                }
            }

            async handleScreenShareConfirm() {
                this.toggleModal('screenshare', false);
                try {
                    await this.startDeepgram();
                    this.state.isMicActive = true;
                    this.updateMicUI(true);
                    this.showToast("Broadcasting System Audio", "success");
                } catch (e) {
                    console.error("System Audio Error", e);
                    this.showToast(e.message || "Screen share failed", "error");
                    this.state.isMicActive = false;
                    this.updateMicUI(false);
                }
            }

            async startDeepgram() {
                let stream;

                if (this.state.audioSource === 'system') {
                    // System Audio (Screen Share)
                    try {
                        stream = await navigator.mediaDevices.getDisplayMedia({
                            video: { width: 1, height: 1 }, // minimal video
                            audio: {
                                echoCancellation: false,
                                noiseSuppression: false,
                                autoGainControl: false,
                                sampleRate: 44100
                            }
                        });
                    } catch (err) {
                        throw new Error("Screen share permission denied");
                    }

                    // Check if user shared audio
                    const audioTrack = stream.getAudioTracks()[0];
                    if (!audioTrack) {
                        stream.getTracks().forEach(t => t.stop());
                        throw new Error("No system audio detected. Did you check 'Share audio'?");
                    }

                    // Handle user stopping screen share via browser UI
                    audioTrack.onended = () => {
                        if (this.state.isMicActive) this.toggleMic();
                    };

                } else {
                    // Standard Microphone with Echo Cancellation for Parallel TTS/STT
                    stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                            sampleRate: 44100
                        }
                    });
                }

                // Wake Lock
                if ('wakeLock' in navigator) {
                    try { this.wakeLock = await navigator.wakeLock.request('screen'); } catch (e) { }
                }

                this.dgClient = createClient(CREDENTIALS.DEEPGRAM);
                this.dgSocket = this.dgClient.listen.live({
                    model: "nova-3",
                    language: this.state.lang.split('-')[0], // Handle en-US etc
                    smart_format: true,
                    interim_results: true,
                    endpointing: 250, // keep as-is
                    utterance_end_ms: 1000
                });

                this.dgSocket.on(LiveTranscriptionEvents.Open, () => {
                    // FIX: Isolate audio track for MediaRecorder to ensure pure audio stream
                    const audioStream = new MediaStream([stream.getAudioTracks()[0]]);

                    // Check if MediaRecorder supports audio/webm, else fallback
                    const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : '';
                    this.mediaRecorder = new MediaRecorder(audioStream, { mimeType });

                    this.mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0 && this.dgSocket.getReadyState() === 1) {
                            this.dgSocket.send(e.data);
                        }
                    };
                    this.mediaRecorder.start(250);
                });

                this.dgSocket.on(LiveTranscriptionEvents.Transcript, (data) => {
                    const transcript = data.channel.alternatives[0].transcript;
                    if (transcript && data.is_final) {
                        // FINAL ONLY -> broadcast
                        this.broadcastMessage(transcript);
                    }

                    // Live UI Update
                    const ui = document.getElementById('teacher-transcript');
                    if (transcript) ui.innerText = transcript;
                });
            }

            stopDeepgram() {
                if (this.mediaRecorder) this.mediaRecorder.stop();
                if (this.dgSocket) this.dgSocket.finish();
                if (this.wakeLock) this.wakeLock.release();

                this.mediaRecorder = null;
                this.dgSocket = null;
            }

            updateMicUI(active) {
                const btn = document.getElementById('mic-btn');
                const bars = document.querySelectorAll('#mic-status div');

                if (active) {
                    btn.classList.add('bg-red-500', 'text-white', 'mic-active-ring');
                    btn.classList.remove('bg-gray-100', 'text-gray-600');
                    if (this.state.audioSource === 'system') {
                        btn.innerHTML = '<i class="fa-solid fa-desktop animate-pulse"></i>';
                    } else {
                        btn.innerHTML = '<i class="fa-solid fa-microphone"></i>';
                    }
                    bars.forEach(b => b.classList.add('bg-red-400'));
                } else {
                    btn.classList.remove('bg-red-500', 'text-white', 'mic-active-ring');
                    btn.classList.add('bg-gray-100', 'text-gray-600');
                    btn.innerHTML = '<i class="fa-solid fa-microphone-slash text-sm"></i>';
                    bars.forEach(b => b.classList.remove('bg-red-400'));
                }
            }

            broadcastMessage(text) {
                push(ref(this.db, `chats/${this.state.room}/messages`), {
                    text: text,
                    lang: this.state.lang,
                    senderName: this.state.name,
                    senderId: this.state.name, // Simple ID for now
                    gender: this.state.gender,
                    timestamp: Date.now()
                });
            }

            // --- QUESTION SEND ---
            sendQuestion() {
                const val = document.getElementById('q-input').value.trim();
                if (!val) return;

                push(ref(this.db, `chats/${this.state.room}/questions`), {
                    text: val,
                    lang: this.state.lang,
                    senderName: this.state.name,
                    timestamp: Date.now()
                });

                document.getElementById('q-input').value = '';
                this.toggleModal('question');
                this.showToast("Question Sent", "success");
            }

            sendReaction(emoji) {
                this.showToast(`Sent ${emoji}`, "success");
                const float = document.createElement('div');
                float.innerText = emoji;
                float.className = 'fixed bottom-20 left-1/2 text-4xl pointer-events-none animate-bounce z-50';
                float.style.transition = 'all 1s ease-out';
                document.body.appendChild(float);
                setTimeout(() => {
                    float.style.transform = 'translateY(-200px) scale(0)';
                    float.style.opacity = '0';
                    setTimeout(() => float.remove(), 1000);
                }, 50);
            }

            copyCode() {
                navigator.clipboard.writeText(this.state.room);
                this.showToast("Copied to clipboard", "success");
            }

            // =========================
            // GPT-4o-mini Translation ‚Üí emotion ‚Üí SSML
            // =========================
            async translateWithAI(text, source, target) {
                // Fast path for empty text
                if (!text || typeof text !== 'string') {
                    return { translated_text: "", emotion: "neutral", ssml: `<emotion value="neutral"></emotion>` };
                }

                // If same language, still analyze emotion for TTS
                if (source === target) {
                    // We could skip AI for speed if "neutral" is acceptable, but to get emotion we need AI.
                    // However, for speed, if same lang, maybe just pass through?
                    // Let's pass through to AI to get the proper emotion tag unless it's very long.
                    // For now, let's just optimize: if same lang, use neutral to save time.
                    // The user wanted "High fidelity", so maybe we should still analyze?
                    // Let's do a fast analysis or just default.
                    // User said "translate it in a very fast using websocket".
                    // Since we don't have websocket for OpenAI here, we proceed with optimized REST.
                }

                const src = source || 'auto';
                const tgt = target || 'en';

                const schema = {
                    type: "object",
                    additionalProperties: false,
                    properties: {
                        translated_text: { type: "string" },
                        emotion: {
                            type: "string",
                            // comprehensive list
                            enum: [
                                "happy", "excited", "enthusiastic", "elated", "euphoric", "triumphant", "amazed", "surprised", "flirtatious", "joking/comedic", "curious", "content", "peaceful", "serene", "calm", "grateful", "affectionate", "trust", "sympathetic",
                                "angry", "mad", "outraged", "frustrated", "agitated", "threatened", "disgusted", "contempt", "envious", "sarcastic", "ironic", "sad", "dejected", "melancholic", "disappointed", "hurt", "guilty", "bored", "tired", "rejected", "anxious", "panicked", "alarmed", "scared",
                                "neutral", "proud", "confident", "distant", "skeptical", "contemplative", "determined", "hesitant", "confused", "resigned", "apologetic", "nostalgic", "wistful", "mysterious", "anticipation"
                            ]
                        }
                    },
                    required: ["translated_text", "emotion"]
                };

                const userPayload = {
                    source_lang: src,
                    target_lang: tgt,
                    text: text,
                    humor_style: "kalog", // Defaulting to kalog as per user preference
                    preserve_markers: true
                };

                const userPrompt = JSON.stringify(userPayload);

                try {
                    const res = await fetch("https://api.moonshot.ai/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${CREDENTIALS.MOONSHOT}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            model: "kimi-latest",
                            messages: [
                                { role: "system", content: TRANSLATION_SYSTEM_PROMPT },
                                { role: "user", content: userPrompt }
                            ],
                            // Kimi does not strictly support json_schema like GPT-4o, 
                            // so we rely on system prompt + manual parsing fallback.
                            temperature: 0.1, // Lower for speed/determinism
                            max_tokens: 1024, // Reduced from 4096 to avoid over-gen
                            stream: false
                        })
                    });

                    if (!res.ok) {
                        const errText = await res.text().catch(() => "");
                        throw new Error(`Moonshot failed(${res.status}): ${errText}`);
                    }

                    const json = await res.json();
                    const content = json.choices?.[0]?.message?.content;

                    if (!content) throw new Error("Moonshot: empty content");

                    let parsed;
                    try {
                        parsed = JSON.parse(content);
                    } catch (e) {
                        // Fallback if JSON broken (unlikely with strict mode)
                        console.warn("JSON parse failed, using raw content");
                        return {
                            translated_text: text,
                            emotion: "neutral",
                            ssml: `<emotion value="neutral">${text}</emotion>`
                        };
                    }

                    const translated_text = String(parsed.translated_text ?? text).trim();
                    const emotion = String(parsed.emotion ?? "neutral").trim();
                    const ssml = `<emotion value="${emotion}">${translated_text}</emotion>`;

                    return { translated_text, emotion, ssml };

                } catch (e) {
                    console.warn("translateWithAI error:", e);
                    // Fail-open
                    return {
                        translated_text: text,
                        emotion: "neutral",
                        ssml: `<emotion value="neutral" />${text}`
                    };
                }
            }

            // =========================
            // Background Play Support (best-effort)
            // =========================
            setupMediaSession() {
                if (!('mediaSession' in navigator)) return;

                try {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: "Success Class Session",
                        artist: "ORBIT",
                        album: "Live Translation"
                    });

                    navigator.mediaSession.setActionHandler('play', async () => {
                        if (!this.state.isTTSActive) {
                            // Respect current UI state: do not force-enable
                            return;
                        }
                        await this.unlockAudioOnce();
                        this.tryPlayNext();
                    });

                    navigator.mediaSession.setActionHandler('pause', () => {
                        try { this.audioEl.pause(); } catch (_) { }
                    });
                } catch (e) {
                    console.warn("MediaSession init failed:", e);
                }
            }

            updateMediaSessionState(playing) {
                if (!('mediaSession' in navigator)) return;
                try {
                    navigator.mediaSession.playbackState = playing ? 'playing' : 'paused';
                } catch (_) { }
            }

            // =========================
            // AI LESSON GENERATOR
            // =========================
            toggleMagicInput() {
                const el = document.getElementById('ai-input-container');
                if (!el) return;
                const isClosed = el.style.maxHeight === '0px' || el.style.maxHeight === '';

                // Adjust height based on content (step 1 vs step 2)
                const isReview = !document.getElementById('ai-step-2').classList.contains('hidden');
                const targetHeight = isReview ? '200px' : '80px';

                el.style.maxHeight = isClosed ? targetHeight : '0px';
                if (isClosed) {
                    setTimeout(() => {
                        const input = isReview ? document.getElementById('magic-review') : document.getElementById('magic-topic');
                        if (input) input.focus();
                    }, 100);
                }
            }

            resetAIInput() {
                document.getElementById('magic-topic').value = '';
                document.getElementById('magic-review').value = '';
                document.getElementById('ai-step-1').classList.remove('hidden');
                document.getElementById('ai-step-2').classList.add('hidden');
                document.getElementById('ai-history-view').classList.add('hidden'); // Ensure history is closed

                // Resize container back to small if open
                const el = document.getElementById('ai-input-container');
                if (el && el.style.maxHeight !== '0px') el.style.maxHeight = '80px';
            }

            toggleHistoryView() {
                const historyView = document.getElementById('ai-history-view');
                const step1 = document.getElementById('ai-step-1');
                const step2 = document.getElementById('ai-step-2');
                const container = document.getElementById('ai-input-container');

                if (historyView.classList.contains('hidden')) {
                    // Open History
                    this.renderHistoryList();
                    step1.classList.add('hidden');
                    step2.classList.add('hidden');
                    historyView.classList.remove('hidden');
                    container.style.maxHeight = '200px';
                } else {
                    // Close History -> Go back to Step 1
                    historyView.classList.add('hidden');
                    step1.classList.remove('hidden');
                    container.style.maxHeight = '80px';
                }
            }

            renderHistoryList() {
                const list = document.getElementById('history-list');
                if (!this.history.length) {
                    list.innerHTML = '<div class="text-center py-4 text-xs text-gray-400 italic">No history yet</div>';
                    return;
                }

                list.innerHTML = this.history.map((item, idx) => `
                    <div onclick="App.loadHistoryItem(${idx})" class="p-2 bg-white rounded border border-gray-100 cursor-pointer hover:border-purple-300 hover:bg-purple-50 transition-all">
                        <div class="font-bold text-xs text-gray-700 truncate">${item.topic}</div>
                        <div class="text-[10px] text-gray-400 truncate">${new Date(item.timestamp).toLocaleTimeString()}</div>
                    </div>
                `).join('');
            }

            loadHistoryItem(idx) {
                const item = this.history[idx];
                if (!item) return;

                document.getElementById('magic-topic').value = item.topic;
                document.getElementById('magic-review').value = item.script;

                // Switch to Review Mode
                document.getElementById('ai-history-view').classList.add('hidden');
                document.getElementById('ai-step-1').classList.add('hidden');
                document.getElementById('ai-step-2').classList.remove('hidden');

                // Ensure container is expanded
                document.getElementById('ai-input-container').style.maxHeight = '200px';
            }

            async generateAIContent(topic) {
                if (!topic || !topic.trim()) return;

                // Show loading state
                const input = document.getElementById('magic-topic');
                input.disabled = true;
                this.showToast("Generating Lesson...", "info");

                const LIVE_CLASS_SYSTEM_PROMPT = `
You are LIVE_CLASS_COMPOSER.
GOAL: Generate spoken teaching text for a live class based on REQUEST.
IMPORTANT: The output MUST be in the language specified in REQUEST.language. If REQUEST.language is not "en", you MUST translate the teaching content naturally into that language.

OUTPUT: Return ONLY raw spoken text (no JSON, no headings, no preamble).
Use short paragraphs (1‚Äì2 sentences each). Keep the cadence like a real teacher.

TRANSLATION-STABLE WRITING RULES (NON-NEGOTIABLE)
1) NO idioms, NO puns, NO culture-specific sayings, NO metaphors that require interpretation.
2) Prefer concrete nouns over pronouns (repeat the noun if needed). Avoid unclear ‚Äúit/they/this/that‚Äù.
3) Keep sentences short (8‚Äì18 words). One idea per sentence.
4) Avoid sarcasm that relies on tone. If humor is used, make it explicit and literal.
5) Keep technical terms consistent. Do not rename the same concept later.
6) Keep numbers, units, and proper nouns unchanged.
7) If you add a joke, it must still be literally correct when translated.

HUMOR (EU STYLE OPTION)
REQUEST.humor_style can be:
- "europe_dry": understated, polite, lightly ironic but still literal.
- "neutral": minimal humor, purely warm and clear.
- "kalog": playful and bubbly, but still no idioms.
REQUEST.humor_level is 0‚Äì3. At 0, no jokes.

INTERACTION SIMULATION
If REQUEST.interaction = true:
- Add exactly ONE brief student moment near the middle:
  Use this literal pattern (do not change it):
  "Okay, quick question from a student: <question>."
  Then answer in 1‚Äì2 sentences and continue.

STRUCTURE
Follow this flow unless REQUEST.format says otherwise:
1) Hook (2 sentences)
2) Core explanation (6‚Äì10 sentences)
3) One student question moment (if enabled)
4) Practical example (3‚Äì5 sentences)
5) Wrap-up + invitation for questions (2‚Äì3 sentences)

SAFETY / TONE
Keep it classroom-safe. No explicit sexual content. No self-harm content. No hate. No illegal instructions.

QUALITY BAR
Sound like a real teacher thinking aloud: allow small fillers like ‚Äúum‚Äù, ‚Äúokay‚Äù, ‚Äúright‚Äù, but keep them rare (max 6 total).
Be specific, accurate, and clear.

Now wait for REQUEST and produce the raw spoken text.
`.trim();

                const userRequest = {
                    topic: topic,
                    language: this.state.lang, // FORCE TEACHER LANGUAGE
                    audience: "adults",
                    difficulty: "beginner",
                    format: "live_class",
                    duration_words: 350,
                    humor_style: "kalog",
                    humor_level: 2,
                    interaction: true
                };

                try {
                    const res = await fetch("https://api.moonshot.ai/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${CREDENTIALS.MOONSHOT}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            model: "kimi-latest",
                            messages: [
                                { role: "system", content: LIVE_CLASS_SYSTEM_PROMPT },
                                { role: "user", content: JSON.stringify(userRequest) }
                            ],
                            temperature: 0.9,
                            max_tokens: 8192,
                            stream: false,
                            tools: [{ type: "builtin_function", function: { name: "$web_search" } }]
                        })
                    });

                    const json = await res.json();
                    const text = json.choices?.[0]?.message?.content;
                    if (!text) throw new Error("No lesson generated");

                    // Populate Review Area
                    document.getElementById('magic-review').value = text;

                    // Save to History
                    this.history.unshift({ topic, script: text, timestamp: Date.now() });
                    // Keep last 20
                    if (this.history.length > 20) this.history = this.history.slice(0, 20);
                    localStorage.setItem('orbit_history', JSON.stringify(this.history));

                    // Switch UI Steps
                    document.getElementById('ai-step-1').classList.add('hidden');
                    document.getElementById('ai-step-2').classList.remove('hidden');

                    // Expand container for textarea
                    const el = document.getElementById('ai-input-container');
                    if (el) el.style.maxHeight = '200px';

                } catch (e) {
                    console.error("Lesson Gen Error", e);
                    this.showToast("Failed to generate lesson", "error");
                } finally {
                    input.disabled = false;
                }
            }

            async startBroadcastSequence() {
                if (this.state.isBroadcasting) return; // Prevent double-clicks

                const text = document.getElementById('magic-review').value;
                if (!text || !text.trim()) return;

                this.state.isBroadcasting = true;

                // UI: Show Stop, Hide Start
                document.getElementById('btn-start-broadcast').classList.add('hidden');
                document.getElementById('btn-stop-broadcast').classList.remove('hidden');

                const chunks = text.match(/[^.!?]+[.!?]+|[^.!?]+$/g) || [text];
                this.showToast("Broadcasting Lesson...", "success");

                // Close the UI immediately
                this.toggleMagicInput();

                // Clear transcript for new broadcast
                const ui = document.getElementById('teacher-transcript');
                if (ui) {
                    ui.innerText = "";
                    ui.classList.remove('italic', 'text-gray-400'); // make it look active
                }

                // Sequential Broadcast with fixed 2s delay
                try {
                    for (let i = 0; i < chunks.length; i++) {
                        // Check if stopped
                        if (!this.state.isBroadcasting) break;

                        const chunk = chunks[i].trim();
                        if (chunk) {
                            this.broadcastMessage(chunk);

                            // Visualize "sending little by little"
                            if (ui) {
                                ui.innerText += (i === 0 ? "" : " ") + chunk;
                                ui.scrollTop = ui.scrollHeight;
                            }

                            await new Promise(r => setTimeout(r, 2000));
                        }
                    }
                } finally {
                    this.stopBroadcast(); // Ensure cleanuup
                }
            }

            stopBroadcast() {
                this.state.isBroadcasting = false;

                // UI: Reset buttons
                const btnStart = document.getElementById('btn-start-broadcast');
                const btnStop = document.getElementById('btn-stop-broadcast');

                if (btnStart) btnStart.classList.remove('hidden');
                if (btnStop) btnStop.classList.add('hidden');

                // If input was closed, reset it? Or keep it closed? 
                // We'll reset the form state essentially
                this.resetAIInput();
                this.showToast("Broadcast Stopped", "info");
            }


        }

        document.addEventListener('DOMContentLoaded', () => new SuccesApp());
    </script>
</body>

</html>
